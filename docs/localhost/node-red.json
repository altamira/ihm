[
    {
        "id": "6621febe.ae69b",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "Start ",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 130,
        "y": 140,
        "wires": [
            [
                "a6c8d83d.1249c8"
            ]
        ]
    },
    {
        "id": "acb613dd.0ea17",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "global.get(conectadoServidor)",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1657.7321243286133,
        "y": 305.3262186050415,
        "wires": []
    },
    {
        "id": "2dbbf445.69a3bc",
        "type": "http in",
        "z": "a18443b1.146f2",
        "name": "maquinas listar",
        "url": "/api/maquina/",
        "method": "get",
        "swaggerDoc": "",
        "x": 183.20825958251953,
        "y": 2174.0880041122437,
        "wires": [
            [
                "a911aaf2.185758"
            ]
        ]
    },
    {
        "id": "5e037439.23b2cc",
        "type": "http response",
        "z": "a18443b1.146f2",
        "name": "",
        "x": 721.2082233428955,
        "y": 2175.0880031585693,
        "wires": []
    },
    {
        "id": "a911aaf2.185758",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Parametros de todas as maquinas",
        "func": "var myDate = new Date().toTimeString().replace(/.*(\\d{2}:\\d{2}:\\d{2}).*/, \"$1\");\n\nvar d = new Date();\nvar x = (\"00\" + (d.getMonth() + 1)).slice(-2) + \"/\" + \n        (\"00\" + d.getDate()).slice(-2) + \"/\" + \n        d.getFullYear() + \" \" + myDate;\n\nmsg.payload = \n[\n  {\n    \"_id\": \"Aplanadora-N3\",\n    \"codigo\": \"PERF-N3\",\n    \"nome\": \"Aplanadora N3\",\n    \"path\": \"maquinas/perfiladeiras/n3\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.230\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.231\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.232\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n    \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9978,\n        \"resolucao\": 2500,\n        \"perimetro\": 400\n      },\n      \"manual\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 95,\n        \"paradaEntrePecasProduzidas\": 0,\n        \"tempoParada\": 0\n      },\n      \"transmissao\": {\n        \"reducao\": 0,\n        \"diametrorolo\": 0,\n        \"avancoMilimetrosPorRotacao\": 9.5144\n      },\n      \"corte\":{\n        \"espessura\": 0,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"passoN2\": 200,\n        \"passoN3\": 200,\n        \"passoN5\": 200\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"10095646\",\n        \"produto\": {\n          \"codigo\": \"ESTCAN000N300000000#2000#0#0\",\n          \"descricao\": \"CANTONEIRA N-3 2000MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"produzindo\"\n      },\n      {\n        \"numero\": \"10095645\",\n        \"produto\": {\n          \"codigo\": \"ESTCAN000N300000000#2400#0#0\",\n          \"descricao\": \"CANTONEIRA N-3 2400MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"pendente\"\n      }\n    ]\n  },\n  {\n    \"_id\": \"Perfiladeira Reforco\",\n    \"codigo\": \"REFORCO\",\n    \"nome\": \"Perfiladeira Reforco\",\n    \"path\": \"maquinas/perfiladeiras/reforco\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.233\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.234\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.235\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n     \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9986,\n        \"resolucao\": 2500,\n        \"perimetro\": 127.32\n      },\n      \"manual\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"0.6\",\n        \"desaceleracao\": \"0.6\",\n        \"velocidade\": 95,\n        \"paradaEntrePecasProduzidas\": 20,\n        \"tempoParada\": 10\n      },\n      \"transmissao\": {\n        \"reducao\": 0,\n        \"diametrorolo\": 0,\n        \"avancoMilimetrosPorRotacao\": 9.5144\n      },\n      \"corte\":{\n        \"espessura\": 5,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"corte\": 1,\n        \"furo\": 20\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"1231-11\",\n        \"produto\": {\n          \"codigo\": \"PPLESTREFOUGAL000000#0#0#610\",\n          \"descricao\": \"PERFIL U GALV P/ APOIO DE CAIXA MED 610MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-11T11:22:08.224Z\",\n        \"status\": \"produzindo\"\n      },\n      {\n        \"numero\": \"8792-55\",\n        \"produto\": {\n          \"codigo\": \"PPLESTREFOUGAL000000#0#0#910\",\n          \"descricao\": \"PERFIL U GALV P/ APOIO DE CAIXA MED 910MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"pendente\"\n      }\n    ]\n  },\n    {\n    \"_id\": \"Perfiladeira Sigma 120\",\n    \"codigo\": \"Sigma 120\",\n    \"nome\": \"Perfiladeira Sigma 120\",\n    \"path\": \"maquinas/perfiladeiras/sigma120\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.236\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.237\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.238\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n     \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9909,\n        \"resolucao\": 2500,\n        \"perimetro\": 400\n      },\n      \"manual\": {\n        \"aceleracao\": \"3\",\n        \"desaceleracao\": \"1\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"2\",\n        \"desaceleracao\": \"1\",\n        \"velocidade\": 100,\n        \"paradaEntrePecasProduzidas\": 40,\n        \"tempoParada\": 2\n      },\n      \"transmissao\": {\n        \"reducao\": \"72.73\",\n        \"diametrorolo\": 165,\n        \"avancoMilimetrosPorRotacao\": 0\n      },\n      \"corte\":{\n        \"espessura\": 5,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"corte\": 1\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"1231-11\",\n        \"produto\": {\n          \"codigo\": \"MEZSIG0CH1412000000#1800#0#0\",\n          \"descricao\": \"VIGA SIGMA 120 CH 2.00 MM MED 1800MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2017-04-10T11:22:08.224Z\",\n        \"status\": \"Produzindo\"\n      },\n      {\n        \"numero\": \"8792-55\",\n        \"produto\": {\n          \"codigo\": \"PPLSTRSI120050D00000#1200#0#0\",\n          \"descricao\": \"STOP TRAZEIRO SIGMA 120 DEITADO MED 1200MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2017-04-14T11:22:08.224Z\",\n        \"status\": \"Pendente\"\n      }\n    ]\n  }\n]\nnode.status({fill:\"blue\",shape:\"dot\",text:x});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 472.2082824707031,
        "y": 2175.0880126953125,
        "wires": [
            [
                "5e037439.23b2cc"
            ]
        ]
    },
    {
        "id": "fdd2785.7dfae88",
        "type": "http in",
        "z": "a18443b1.146f2",
        "name": "maquinas alterar",
        "url": "/api/maquina/",
        "method": "put",
        "swaggerDoc": "",
        "x": 184.06539916992188,
        "y": 2267.088018089533,
        "wires": [
            []
        ]
    },
    {
        "id": "6e69b432.b9bbcc",
        "type": "http response",
        "z": "a18443b1.146f2",
        "name": "",
        "x": 654.0653991699219,
        "y": 2267.088018089533,
        "wires": []
    },
    {
        "id": "ae48766.5c8a988",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "SQL",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 434.0653991699219,
        "y": 2267.088018089533,
        "wires": [
            [
                "6e69b432.b9bbcc"
            ]
        ]
    },
    {
        "id": "f60d4594.6bf838",
        "type": "http in",
        "z": "a18443b1.146f2",
        "name": "maquinas incluir",
        "url": "/api/maquina/",
        "method": "post",
        "swaggerDoc": "",
        "x": 184.06539916992188,
        "y": 2218.088018089533,
        "wires": [
            []
        ]
    },
    {
        "id": "ed071a0a.9d0048",
        "type": "http response",
        "z": "a18443b1.146f2",
        "name": "",
        "x": 654.0653991699219,
        "y": 2218.088018089533,
        "wires": []
    },
    {
        "id": "3a2f8368.ee3f4c",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "SQL",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 434.0653991699219,
        "y": 2218.088018089533,
        "wires": [
            [
                "ed071a0a.9d0048"
            ]
        ]
    },
    {
        "id": "4713580c.9c8288",
        "type": "http in",
        "z": "a18443b1.146f2",
        "name": "/api/maquina/config",
        "url": "/api/maquina/config",
        "method": "get",
        "swaggerDoc": "",
        "x": 146.73212432861328,
        "y": 298.3262186050415,
        "wires": [
            [
                "8874b641.ff5c48"
            ]
        ]
    },
    {
        "id": "3ddab26e.4527ee",
        "type": "http response",
        "z": "a18443b1.146f2",
        "name": "",
        "x": 886.7321243286133,
        "y": 207.3262186050415,
        "wires": []
    },
    {
        "id": "4ad38845.46cad8",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "resposta mongo config OK",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 955.7321243286133,
        "y": 256.3262186050415,
        "wires": []
    },
    {
        "id": "f0ef29bc.b00018",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "config IHM",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 908.7321243286133,
        "y": 485.3262186050415,
        "wires": []
    },
    {
        "id": "1c55942.422bb6c",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "INICIALIZA VARIAVEIS GLOBAIS DAS MAQUINAS",
        "info": "",
        "x": 246.25,
        "y": 96.74999666213989,
        "wires": []
    },
    {
        "id": "f48c3830.72f958",
        "type": "http in",
        "z": "a18443b1.146f2",
        "name": "/api/maquina/config/save",
        "url": "/api/maquina/config",
        "method": "post",
        "swaggerDoc": "",
        "x": 171.73212432861328,
        "y": 585.3262491226196,
        "wires": [
            [
                "c1ae7bef.98fe98"
            ]
        ]
    },
    {
        "id": "f7581a04.c29f38",
        "type": "http response",
        "z": "a18443b1.146f2",
        "name": "",
        "x": 888.4463939666748,
        "y": 578.4690504074097,
        "wires": []
    },
    {
        "id": "93e3b589.fc4b18",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "APAGAR log_erro",
        "collection": "log_erro",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "delete",
        "x": 926.7321243286133,
        "y": 355.3262186050415,
        "wires": []
    },
    {
        "id": "f33752c0.b1cb1",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Apagar Cuidado \"Teste\"",
        "info": "#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ",
        "x": 164.06538200378418,
        "y": 1767.6593030393124,
        "wires": []
    },
    {
        "id": "ba61d357.3e8e9",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "APAGAR TODA A COLLECTION config",
        "collection": "config",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "delete",
        "x": 564.1765441894531,
        "y": 1809.6593017578125,
        "wires": []
    },
    {
        "id": "f3bec9c.2fbca38",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "LIMPAR coleção config",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 187.81869316101074,
        "y": 1808.6084807813168,
        "wires": [
            [
                "ba61d357.3e8e9",
                "3252683a.dafc58"
            ]
        ]
    },
    {
        "id": "8265bf78.56934",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "APAGAR indice",
        "collection": "indice",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "delete",
        "x": 917.5838394165039,
        "y": 401.65973377227783,
        "wires": []
    },
    {
        "id": "daa77929.e90138",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "String vazia",
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 233.73212432861328,
        "y": 2561.6594457626343,
        "wires": [
            [
                "9b1ea02f.ac478"
            ]
        ]
    },
    {
        "id": "398b9bb3.eaa134",
        "type": "mongodb in",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "consulta",
        "collection": "parametros",
        "operation": "find",
        "x": 752.6992950439453,
        "y": 2562.0149421691895,
        "wires": [
            [
                "aec3144e.11c6f8"
            ]
        ]
    },
    {
        "id": "aec3144e.11c6f8",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "resposta do MongoDB",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1036.8103370666504,
        "y": 2562.126097679138,
        "wires": []
    },
    {
        "id": "9161f1c0.3d7e2",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "contador +1",
        "func": "msg.query = { _id: 'AplanadoraN3' }\nmsg.payload = {\n    $inc: {\n       \"os.produzido\": 1\n     }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 554.9213943481445,
        "y": 2468.592764854431,
        "wires": [
            [
                "229ddf7c.d1a2b"
            ]
        ]
    },
    {
        "id": "229ddf7c.d1a2b",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "salvar",
        "collection": "parametros",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "update",
        "x": 762.9213790893555,
        "y": 2468.9927587509155,
        "wires": []
    },
    {
        "id": "c5cd399b.871198",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "$inc: incrementa",
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 241.75493240356445,
        "y": 2468.259461402893,
        "wires": [
            [
                "9161f1c0.3d7e2",
                "931077e3.5c8718"
            ]
        ]
    },
    {
        "id": "9b1ea02f.ac478",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Paginação ",
        "func": "msg.limit = 5;\nmsg.skip = 0;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 551.143648147583,
        "y": 2562.07422542572,
        "wires": [
            [
                "398b9bb3.eaa134"
            ]
        ]
    },
    {
        "id": "22c3a69f.9d084a",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Paginação  e consulta MongoDB",
        "info": "#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ",
        "x": 269.92148208618164,
        "y": 2525.926064968109,
        "wires": []
    },
    {
        "id": "931077e3.5c8718",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n    node.send(msg);\n}, 50);\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 554.2547988891602,
        "y": 2504.037052154541,
        "wires": [
            [
                "9b1ea02f.ac478"
            ]
        ]
    },
    {
        "id": "59de4224.1ff8bc",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Contador Produzidos ++ ",
        "info": "#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ",
        "x": 246.9209747314453,
        "y": 2432.9260215759277,
        "wires": []
    },
    {
        "id": "a6c8d83d.1249c8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Variaveis Globais",
        "func": "//Estado inicial da maquina é não inicializada MaqInicializada=0\nglobal.set('conectadoServidor', 0);\nglobal.set(\"ComandoMaquina\",0);//liberamensagens do bloco libera maquina\nglobal.set(\"MotorPrensa\",0);\nglobal.set(\"MotorLigado\",0);\nglobal.set(\"MotorInvertido\",0);\nglobal.set(\"Desbobinador\",0);\nglobal.set(\"Indice_Mongo\",0);\nglobal.set(\"TamanhoDesejadoPeca_KEYBOARD\",0);\nglobal.set(\"TamanhoRealPeca_KEYBOARD\",0);\nglobal.set(\"FatorEncoder\",9909);\nglobal.set(\"ModBus\",[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);\nvar start = new Date().getTime();\nglobal.set(\"tempo\",start);\n\nvar mensagens = [];\n\nmensagens['LER_CLP_MODBUS'] =        { type: 'error', message: ' CLP não responde. Verifique as conexões de rede.' };\nmensagens['EMERGENCIA'] =            { type: 'error', message: ' Emergencia acionada!' };\nmensagens['FALTA_FASE'] =            { type: 'error', message: ' Falta de Fase' };\nmensagens['BOMBA_HIDRAULICA'] =      { type: 'error', message: ' Térmico da Bomba Hidraulica' };\nmensagens['MARTELO_PRENSA'] =        { type: 'error', message: ' Térmico do Motor do Martelo Prensa' };\nmensagens['PRESSAO_AR'] =            { type: 'warning', message: 'Pressao do Ar Baixa!' };\nmensagens['INVERSOR'] =              { type: 'error', message: ' Erro no Inversor' };\nmensagens['SERVO'] =                 { type: 'error', message: ' Erro no Servo' };\nmensagens['CHAVE_GERAL_DESLIGADA'] = { type: 'warning', message: ' Chave Geral Desligada' };\nmensagens['CHAVE_GERAL_LIGADA']    = { type: 'warning', message: ' Chave Geral ligada' };\nmensagens['MAQUINA_NAO_LIBERADA'] =  { type: 'warning', message: ' Maquina Não Liberada' };\nmensagens['MAQUINA_LIBERADA']     =  { type: 'warning', message: ' Maquina Liberada' };\nmensagens['ERRO_POSICIONAMENTO']=    { type: 'error', message: ' Erro Posicionamento' };\nmensagens['SEGURAN_PRENSA'] =        { type: 'info', message: ' Segurança da Prensa' };\nmensagens['APLAN_ABERTA'] =          { type: 'info', message: ' Aplanadora Aberda' };\n\nglobal.set(\"mensagens\",mensagens);\nmsg= {payload: \"{MAQUINA_OFF:0}\"};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 291.47843170166016,
        "y": 139.69614028930664,
        "wires": [
            []
        ]
    },
    {
        "id": "e21a3edd.5e285",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 100ms",
        "func": "setTimeout(function() {\n    node.send(msg);\n}, 100);\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 1132.7321243286133,
        "y": 305.3262186050415,
        "wires": [
            [
                "52df09cc.7ff8e8",
                "f5ad3d78.5d0a9",
                "183fdffd.de62e"
            ]
        ]
    },
    {
        "id": "52df09cc.7ff8e8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "CONEXAO C/ SERVIDOR",
        "func": "if(global.get('conectadoServidor')){\n    console.dir('CONECTADO AO SERVIDOR !');\n    node.status({fill:\"blue\",shape:\"dot\",text:'CONECTADO COM SERVIDOR'});\n}else{\n    console.dir('-------------> ERRO NA CONEXAO PRODUCAO !!!!!! <-------------');\n    global.set('conectadoServidor', 0);\n    node.status({fill:\"red\",shape:\"dot\",text:'ERRO'});\n}\n\nmsg= {payload: global.get('conectadoServidor')};\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1387.7321243286133,
        "y": 305.3262186050415,
        "wires": [
            [
                "acb613dd.0ea17"
            ]
        ]
    },
    {
        "id": "27e7a1.7caec86",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "salvar",
        "collection": "log_erro",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "store",
        "x": 1587.7321243286133,
        "y": 353.3262186050415,
        "wires": []
    },
    {
        "id": "f5ad3d78.5d0a9",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "collection inicial log_erro",
        "func": "let myDate = new Date().toTimeString().replace(/.*(\\d{2}:\\d{2}:\\d{2}).*/, \"$1\");\nlet d = new Date();\nconst x = ((\"00\" + (d.getMonth() + 1)).slice(-2) + \"/\" + \n        (\"00\" + d.getDate()).slice(-2) + \"/\" + \n        d.getFullYear() + \" \" + myDate)||0;\n        \nmsg.payload = {\n\t\"_id\": 1,\n\t\"log_mesagens\": {\n\t}\n}\nnode.status({fill:\"blue\",shape:\"dot\",text:x});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1386.4910736083984,
        "y": 353.4309911727905,
        "wires": [
            [
                "27e7a1.7caec86"
            ]
        ]
    },
    {
        "id": "d90d3fc.9859bc",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "salvar",
        "collection": "indice",
        "payonly": true,
        "upsert": false,
        "multi": true,
        "operation": "store",
        "x": 1588.7321243286133,
        "y": 401.3262186050415,
        "wires": []
    },
    {
        "id": "183fdffd.de62e",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "collection inicial indice",
        "func": "msg.payload = {\n\t\"_id\": \"indice\",\n\t\"indice_mesagens\": 0\n}\n\nnode.status({fill:\"blue\",shape:\"dot\",text:'Indice Criado'});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1377.7321243286133,
        "y": 401.3262186050415,
        "wires": [
            [
                "d90d3fc.9859bc"
            ]
        ]
    },
    {
        "id": "86b42f08.d8a39",
        "type": "e-mail in",
        "z": "a18443b1.146f2",
        "name": "ihmaltamira@gmail.com",
        "protocol": "IMAP",
        "server": "imap.gmail.com",
        "useSSL": true,
        "port": "993",
        "box": "INBOX",
        "disposition": "Read",
        "repeat": "400",
        "x": 331.88140869140625,
        "y": 3038.695068359375,
        "wires": [
            [
                "ff645435.800588"
            ]
        ]
    },
    {
        "id": "ff645435.800588",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "recebidos",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 536.5927467346191,
        "y": 3038.851613998413,
        "wires": []
    },
    {
        "id": "a67dd4fd.f7f868",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "EMAIL RECADO",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 858.8315238952637,
        "y": 3126.9624967575073,
        "wires": []
    },
    {
        "id": "c8eebda0.2beea",
        "type": "e-mail",
        "z": "a18443b1.146f2",
        "server": "smtp.gmail.com",
        "port": "587",
        "secure": false,
        "name": "ihmaltamira@gmail.com",
        "dname": "",
        "x": 877.83154296875,
        "y": 3189.962646484375,
        "wires": []
    },
    {
        "id": "d2ddc1fc.a4e83",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "",
        "func": "msg.payload = \"Testando 500 o envio de emails pelo node-red\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 596.83154296875,
        "y": 3188.962646484375,
        "wires": [
            [
                "c8eebda0.2beea",
                "31b8dc54.0c4694"
            ]
        ]
    },
    {
        "id": "31b8dc54.0c4694",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 817.83154296875,
        "y": 3244.962646484375,
        "wires": []
    },
    {
        "id": "9a2f8b50.60d5d8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Corpo do email",
        "func": "msg.payload = \n`\n<!DOCTYPE html>\n<html>\n<head>\n <meta charset=\"utf-8\">\n <title>Alimentador N3</title>\n</head>\n<body>\n\n <div>\n <h2>Recado</h2>\n <table>\n <tr>\n <td><b>Produto</b></td>\n <td><nobr>${msg.payload.erro}</nobr></td>\n </tr>\n <tr>\n <td><b>Telefone</b></td>\n <td><nobr>(${msg.payload.ddd}) ${msg.payload.telefone}</nobr></td>\n </tr>\n <tr>\n <td><b>Região</b></td>\n <td><nobr>\"testando\"</nobr></td>\n </tr>\n </table>\n </div>\n\n</body>\n</html>\n`\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 568.8315238952637,
        "y": 3126.9624967575073,
        "wires": [
            [
                "a67dd4fd.f7f868",
                "c5c14173.7c3e7"
            ]
        ]
    },
    {
        "id": "25243681.8b4d3a",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Deserializador global \"Referencia\"",
        "info": "var msgs = [];\nvar g = (global.get(\"M\")||[0]);\nfor(z = 0; z < g.length) {\nfor (i = 0; i < 15; i++) {\n msgs.push(\n {\n _msgid: msg._msgid,\n topic: msg.topic,\n payload: g[z] & (1 << i)\n }\n );\n}\n}\n//var type = msg.payload[0] & 1 ? 'error' : 'warning';\n\n//var count = flow.get(\"CONTADOR_ERRO_M2\");\n//count++;\n\n\nreturn msgs;",
        "x": 2203.7321243286133,
        "y": 2928.3262186050415,
        "wires": []
    },
    {
        "id": "6e75f7c4.1756d8",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "Inicialização MAQ",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 1900.880989074707,
        "y": 1482.7670450210571,
        "wires": [
            []
        ]
    },
    {
        "id": "c6ec7f07.174f",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "Topico Estado da Maquina",
        "topic": "AplanadoraN/Estado",
        "qos": "0",
        "retain": "false",
        "broker": "d8f46f1a.2a7e2",
        "x": 3899.678482055664,
        "y": 2123.6718492507935,
        "wires": []
    },
    {
        "id": "86b2c265.5af6e",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Global ModBus Referencias",
        "func": "global.set(\"ModBus\", msg.payload);\nmsg2 = {};\nmsg2.payload = \"Iguail\";\nvar Anterior =(global.get(\"Anterior\")||[0]);\nvar ValorAtual = global.get(\"ModBus\");\nmsg = null;\n\nfor (var i = 0; i < Anterior.length; i++) {\n \n if (Anterior[i] != ValorAtual[i]) {\n msg2.payload = \"Diferente\";\n global.set(\"Anterior\", ValorAtual);\n msg = {payload:ValorAtual};\n break;\n } \n}\nreturn [msg,msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2184.1429595947266,
        "y": 2969.040593147278,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "b5f08bec.598948",
        "type": "mqtt in",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "board/setup",
        "qos": "2",
        "broker": "d8f46f1a.2a7e2",
        "x": 1193.7321243286133,
        "y": 2308.3262186050415,
        "wires": [
            [
                "e3f03d6b.239e",
                "f63cd1d4.5df32"
            ]
        ]
    },
    {
        "id": "e3f03d6b.239e",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Registradores de Comandos",
        "func": "var p = JSON.parse(msg.payload);\nvar res = [null,null,null,null,null,null,null,null,null,null,null,null,null];\nvar modbus = global.get(\"ModBus\");\n \n //***** INICIALIZA OU DESLIGA MAQUINA *****//\n if (p.LigarMaquina !== undefined) {\n if (modbus[2] & (1 << 11)) {\n modbus[2] &= ~(1<<11); //M2.11 igual a 1 MbLigaChaveGeral\n node.status({fill:\"red\",shape:\"ring\",text:\"Geral Desligada\"});\n } else {\n modbus[2] |= (1<<11); //M2.11 igual a 0 MbLigaChaveGeral\n node.status({fill:\"green\",shape:\"dot\",text:\"Geral Ligada\"});\n }\n global.set(\"ComandoMaquina\",1); \n global.set('ModBus', modbus); //Atualiza registrador global.\n res[0] = {payload:modbus[2]}; //Primeiro liga ou desliga chave geral\n }\n \n //***** ON/OFF MOTOR *****//\n if (p.LigarPrensa !== undefined) {\n if ((modbus[3]) & (1 << 3)) {\n modbus[3] &= ~(1<<3); //M3.3 igual a 1 DbPrsLigaMotor\n global.set(\"MotorLigado\",0);\n node.status({fill:\"red\",shape:\"ring\",text:\"Motor OFF\"});\n } else {\n modbus[3] |= (1<<3);//M3.3 igual a 0 DbPrsParar\n global.set(\"MotorLigado\",1);\n node.status({fill:\"green\",shape:\"dot\",text:\"Motor ON\"});\n }\n global.set(\"ComandoMaquina\",2);\n global.set('ModBus', modbus);//Atualiza registrador global.\n res[1] = {payload: modbus[3]};\n }\n \n //***** ABRIR TAMPA MODBUS 31.10 *****//\n if (p.abrirTampa !== undefined) {\n if (p.abrirTampa == '1'){\n modbus[31] |= (1<<10); \n }else if (p.abrirTampa == '0'){\n modbus[31] = 0; \n }\n global.set(\"ComandoMaquina\",3);\n res[2] = {payload:(modbus[31])};\n }\n \n //***** FECHAR TAMPA MODBUS 31.11 *****//\n if (p.fecharTampa !== undefined) {\n if(p.fecharTampa == '1'){\n modbus[31] |= (1<<11); \n }else if (p.fecharTampa == '0'){\n modbus[31] = 0;\n }\n global.set(\"ComandoMaquina\",4);\n res[3] = {payload:(modbus[31])};\n }\n \n //***** AVANCAR PERFIL MODBUS 2.3 *****//\n if (p.avancaPerfil !== undefined) {\n if(p.avancaPerfil == '1'){\n modbus[2] |= (1<<3); \n }else if (p.avancaPerfil == '0'){\n modbus[2] &= ~(1<<3);\n }\n global.set(\"ComandoMaquina\",5);\n res[4] = {payload: modbus[2]};\n }\n //***** RECUAR PERFIL MODBUS 2.4 *****//\n if (p.recuaPerfil !== undefined) {\n if(p.recuaPerfil == '1'){\n modbus[2] |= (1<<4); \n }else if (p.recuaPerfil == '0'){\n modbus[2] &= ~(1<<4);\n }\n global.set(\"ComandoMaquina\",6); \n res[5] = {payload:modbus[2]};\n }\n \n //*****botao_Parar_Maquina***********//\n if (p.botao_Parar_Maquina !== undefined) {\n modbus[2] |= (1<<13); //M2.13 igual a 0 MbPrsParar\n modbus[2] &= ~(1<<0); //M2.0 igual a 0 MbModoAuto\n node.status({fill:\"red\",shape:\"ring\",text:\"Parando prensa\"});\n global.set(\"ComandoMaquina\",7);\n global.set('ModBus', modbus);//Atualiza registrador global.\n res[6] = {payload: modbus[2]};\n }\n \n //*****botao_Manual************//\n if (p.botao_Manual !== undefined) {\n modbus[3] |= 1; //Libera maquina\n modbus[2] &= ~(1<<0); //M2.0 igual a 0 MbModoAuto\n node.status({fill:\"red\",shape:\"ring\",text:\"Modo Manual\"});\n global.set(\"ComandoMaquina\",8);\n global.set('ModBus', modbus);//Atualiza registrador global.\n res[7] = {payload: modbus[2]};\n }\n \n //*****botao_Produzir*********//\n if (p.botao_Produzir !== undefined) {\n modbus[3] |= 1; //Libera maquina\n if ((modbus[2]) & (1 << 0)) {\n modbus[2] &= ~(1<<0); //M2.0 igual a 1 produzir\n node.status({fill:\"green\",shape:\"dot\",text:\"Produzindo\"});\n } else {\n modbus[2] |= (1<<0);//M2.0 igual a 0 não produzir\n node.status({fill:\"red\",shape:\"ring\",text:\"Não produzindo\"});\n }\n global.set(\"ComandoMaquina\",9);\n global.set('ModBus', modbus);//Atualiza registrador global.\n res[8] = {payload: modbus[2]};\n }\n \n //***** Reverçao do motor da prensa *****//\n if (p.SentidoInv !== undefined) {\n if ((modbus[2]) & (1 << 14)) {\n modbus[2] &= ~(1<<14); //M2.14 igual a 1 MbPrsSentidoInv\n global.set(\"MotorInvertido\",0);\n node.status({fill:\"blue\",shape:\"ring\",text:\"Motor normal\"});\n } else {\n modbus[2] |= (1<<14);//M3.3 igual a 0 DbPrsParar\n global.set(\"MotorInvertido\",1);\n node.status({fill:\"green\",shape:\"dot\",text:\"Motor Invertido\"});\n }\n global.set(\"ComandoMaquina\",10);\n global.set('ModBus', modbus);//Atualiza registrador global.\n res[9] = {payload: modbus[2]};\n }\n \n //***** DESLIGA MAQUINA depois zera tudo *****//\n if (p.ResetMaquina !== undefined) {\n modbus[2] &= ~(1<<11); \n node.status({fill:\"red\",shape:\"ring\",text:\"Geral Desligada e reset\"});\n global.set(\"ComandoMaquina\",0); \n global.set('ModBus', modbus); //Atualiza registrador global.\n res[10] = {payload:modbus[2]}; //Primeiro desliga chave geral\n }\n \n //*****Desbobinador ******//\n if (p.AceleracaoAuto !== undefined) {\n var x = global.get(\"Desbobinador\");\n if(x){\n global.set('Desbobinador', 0);//Atualiza registrador global.\n }else{\n global.set('Desbobinador', 1);//Atualiza registrador global.\n }\n global.set(\"ComandoMaquina\",11);\n res[11] = {payload: global.get(\"Desbobinador\")};\n }\n \n //*****Atualiza TABS-2**************//\n if (p.AtualizarRegistradores !== undefined) {\n node.status({fill:\"red\",shape:\"ring\",text:\"Tab-2\"});\n res[12] = {payload: 1};\n }\n \nreturn res;",
        "outputs": "13",
        "noerr": 0,
        "x": 1490.9105529785156,
        "y": 2309.1096243858337,
        "wires": [
            [
                "81d90c6b.84bd6"
            ],
            [
                "ae99b105.db4fb"
            ],
            [
                "dbc054b6.8eeb08"
            ],
            [
                "38244759.9143a8"
            ],
            [
                "93f393b9.5c9e5"
            ],
            [
                "1fd39b0e.1db565"
            ],
            [
                "26ecf631.2047ba"
            ],
            [
                "65ff54ca.103bdc"
            ],
            [
                "e9ba66cf.0fb248"
            ],
            [
                "af83648a.23dff8"
            ],
            [
                "e831add7.3daed"
            ],
            [
                "79ca2f6b.66bb4"
            ],
            [
                "5cfe9ef7.3c779"
            ]
        ]
    },
    {
        "id": "ae99b105.db4fb",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Liga Motor Prensa M3.3",
        "dataType": "HoldingRegister",
        "adr": "3",
        "server": "357d20ae.edfc8",
        "x": 1871.2586212158203,
        "y": 2017.5119681358337,
        "wires": [
            [
                "3fbf62ba.04f2ee"
            ],
            [
                "6a279f7e.a001b"
            ]
        ]
    },
    {
        "id": "93f393b9.5c9e5",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Perfil Avança M2.3",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 1852.639736175537,
        "y": 2226.7975034713745,
        "wires": [
            [
                "3332960c.3d002a"
            ],
            [
                "834693.aaada97"
            ]
        ]
    },
    {
        "id": "38244759.9143a8",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Aplanadora Fecha M31.11",
        "dataType": "HoldingRegister",
        "adr": "31",
        "server": "357d20ae.edfc8",
        "x": 1862.9252014160156,
        "y": 2158.3690180778503,
        "wires": [
            [
                "9a3f5dd5.63c6f"
            ],
            [
                "87346430.699b98"
            ]
        ]
    },
    {
        "id": "dbc054b6.8eeb08",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Aplanadora Abre M31.10",
        "dataType": "HoldingRegister",
        "adr": "31",
        "server": "357d20ae.edfc8",
        "x": 1872.0681457519531,
        "y": 2087.3690180778503,
        "wires": [
            [
                "44ae657e.5f109c"
            ],
            [
                "ae63b58c.fce338"
            ]
        ]
    },
    {
        "id": "1fd39b0e.1db565",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Perfil Recua M2.4",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 1851.3539390563965,
        "y": 2297.797392845154,
        "wires": [
            [
                "f696e1b0.1467f"
            ],
            [
                "e02749aa.215db8"
            ]
        ]
    },
    {
        "id": "6cd10ea9.ae584",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Registradores R/W Setup da Aplanadora \"HTML\"",
        "info": "#test\n- nao\n- sei\n- onde v\n- vai \n- parar\n- isso",
        "x": 1856.5498352050781,
        "y": 1889.7332816123962,
        "wires": []
    },
    {
        "id": "acfa9534.156d98",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Erro comunicação Escrita",
        "func": "msg.payload = {\n time: new Date(),\n type: 'error',\n message: 'Falha de escrita dos modbus do CLP.'\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3644.6894760131836,
        "y": 2123.238495826721,
        "wires": [
            [
                "c6ec7f07.174f"
            ]
        ]
    },
    {
        "id": "fb8c3b6e.b213c8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Variaveis Globais",
        "func": "//Estado inicial da maquina é não inicializada MaqInicializada=0\nglobal.set(\"ComandoMaquina\",0);//liberamensagens do bloco libera maquina\nglobal.set(\"MotorPrensa\",0);\nglobal.set(\"MotorLigado\",0);\nglobal.set(\"MotorInvertido\",0);\nglobal.set(\"Desbobinador\",0);\nglobal.set(\"Indice_Mongo\",0);\nglobal.set(\"TamanhoDesejadoPeca_KEYBOARD\",0);\nglobal.set(\"TamanhoRealPeca_KEYBOARD\",0);\nglobal.set(\"FatorEncoder\",9909);\nglobal.set(\"ModBus\",[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);\nvar start = new Date().getTime();\nglobal.set(\"tempo\",start);\n\nvar mensagens = [];\n\nmensagens['LER_CLP_MODBUS'] = { type: 'error', message: ' CLP não responde. Verifique as conexões de rede.' };\nmensagens['EMERGENCIA'] = { type: 'error', message: ' Emergencia acionada!' };\nmensagens['FALTA_FASE'] = { type: 'error', message: ' Falta de Fase' };\nmensagens['BOMBA_HIDRAULICA'] = { type: 'error', message: ' Térmico da Bomba Hidraulica' };\nmensagens['MARTELO_PRENSA'] = { type: 'error', message: ' Térmico do Motor do Martelo Prensa' };\nmensagens['PRESSAO_AR'] = { type: 'error', message: 'Pressao do Ar Baixa!' };\nmensagens['INVERSOR'] = { type: 'error', message: ' Erro no Inversor' };\nmensagens['SERVO'] = { type: 'error', message: ' Erro no Servo' };\nmensagens['CHAVE_GERAL_DESLIGADA'] = { type: 'warning', message: ' Chave Geral Desligada' };\nmensagens['CHAVE_GERAL_LIGADA'] = { type: 'warning', message: ' Chave Geral ligada' };\nmensagens['MAQUINA_NAO_LIBERADA'] = { type: 'warning', message: ' Maquina Não Liberada' };\nmensagens['MAQUINA_LIBERADA'] = { type: 'warning', message: ' Maquina Liberada' };\nmensagens['ERRO_POSICIONAMENTO']= { type: 'error', message: ' Erro Posicionamento' };\nmensagens['SEGURAN_PRENSA'] = { type: 'info', message: ' Segurança da Prensa' };\nmensagens['APLAN_ABERTA'] = { type: 'info', message: ' Aplanadora Aberda' };\n\nglobal.set(\"mensagens\",mensagens);\nmsg= {payload: \"{MAQUINA_OFF:0}\"};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2444.0593910217285,
        "y": 1484.3031096458435,
        "wires": [
            [
                "1fb5540b.dd923c"
            ]
        ]
    },
    {
        "id": "49f23bfa.828b54",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Ligou geral?",
        "func": "//verifica 2.11 e libera 3.0\nvar mensagens = global.get(\"mensagens\");\nvar modbus = global.get(\"ModBus\");\nvar msg2 = {};\n\n\nif (((modbus[2]) & (1 << 11))) {\n modbus[3] |= 1; //M3.0 igual a 1 libera maquina\n msg.payload = modbus[3];\n msg2.payload = mensagens['CHAVE_GERAL_LIGADA'];\n msg2.payload.time= new Date();\n node.status({fill:\"green\",shape:\"dot\",text:\"Chave Ligada\"});\n}else if (~((modbus[2]) & (1 << 11))){ \n modbus[3] &= 0;\n msg.payload = 0;\n msg2.payload = mensagens['CHAVE_GERAL_DESLIGADA'];\n msg2.payload.time= new Date();\n node.status({fill:\"yellow\",shape:\"ring\",text:\"Chave Deslidaga\"});\n}else {\n node.status({fill:\"red\",shape:\"ring\",text:\"Bug\"});\n}\n \n\nglobal.set('ModBus', modbus);//Atualiza registrador global\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2583.880962371826,
        "y": 1934.7078928947449,
        "wires": [
            [
                "81b07e20.d095a"
            ],
            [
                "39d211bf.6568be"
            ]
        ]
    },
    {
        "id": "81d90c6b.84bd6",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "LigaGeral M2.11",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 1851.3270568847656,
        "y": 1949.8258051872253,
        "wires": [
            [
                "c0dab987.8f8b98"
            ],
            [
                "5494fb24.3819b4"
            ]
        ]
    },
    {
        "id": "1dac4c45.62fc94",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Libera Maquina M3.0",
        "dataType": "HoldingRegister",
        "adr": "3",
        "server": "357d20ae.edfc8",
        "x": 3046.5991134643555,
        "y": 1928.3544001579285,
        "wires": [
            [
                "2af0ca8e.6c7306"
            ],
            [
                "d679d327.0d02c"
            ]
        ]
    },
    {
        "id": "cfd06768.eca7d8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Erro comunicação",
        "func": "var mensagens = global.get(\"mensagens\");\n//var modbus = global.get(\"ModBus\");\n\nmsg.payload = mensagens['LER_CLP_MODBUS'];\nmsg.payload.time= new Date();\n\n//global.set('ModBus', modbus);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2168.768772125244,
        "y": 1424.6472563743591,
        "wires": [
            [
                "5ed04ade.9886d4",
                "fb8c3b6e.b213c8"
            ]
        ]
    },
    {
        "id": "34b1bef5.75c282",
        "type": "modbustcp-no-pooling-read",
        "z": "a18443b1.146f2",
        "name": "Read POP",
        "dataType": "HoldingRegister",
        "adr": "0",
        "quantity": "32",
        "server": "357d20ae.edfc8",
        "x": 1919.3452491760254,
        "y": 1417.484628200531,
        "wires": [
            [
                "a19b0602.047a28",
                "533dc177.941ae"
            ],
            [
                "cfd06768.eca7d8"
            ]
        ]
    },
    {
        "id": "af87eb6.d706118",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "atualizar",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "5",
        "crontab": "",
        "once": false,
        "x": 1547.0236549377441,
        "y": 1416.9813933372498,
        "wires": [
            [
                "7b4d4c6c.1f9d14"
            ]
        ]
    },
    {
        "id": "31e315e.25d5dea",
        "type": "link in",
        "z": "a18443b1.146f2",
        "name": "Atualizacao dos 32 registradores ModBus",
        "links": [
            "996aeb43.46e098",
            "44ae657e.5f109c",
            "9a3f5dd5.63c6f",
            "3332960c.3d002a",
            "f696e1b0.1467f",
            "79ca2f6b.66bb4"
        ],
        "x": 2158.4762649536133,
        "y": 2103.771653175354,
        "wires": [
            [
                "bfe3a0a9.67e07"
            ]
        ]
    },
    {
        "id": "852160e7.76eea",
        "type": "link in",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "c0dab987.8f8b98",
            "3fbf62ba.04f2ee",
            "b4a4312e.324d5",
            "ebf93874.b9f548",
            "893ab752.717988",
            "419f5d36.434da4",
            "fc304fda.e4611"
        ],
        "x": 1592.7809524536133,
        "y": 1344.9170999526978,
        "wires": [
            [
                "7b4d4c6c.1f9d14"
            ]
        ]
    },
    {
        "id": "c0dab987.8f8b98",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "852160e7.76eea"
        ],
        "x": 2032.0888710021973,
        "y": 1930.2354941368103,
        "wires": []
    },
    {
        "id": "996aeb43.46e098",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Atualizacao dos 32 registradores ModBus",
        "links": [
            "31e315e.25d5dea",
            "278b8d9f.332cc2",
            "3292c332.e62afc",
            "17d59d24.8682a3",
            "fded0008.003bb8",
            "91bb35aa.506f38",
            "7a9f7416.07fd14",
            "ffc2b971.50fa4",
            "777bd47b.b983dc",
            "a99b0250.54b63"
        ],
        "x": 2823.538724899292,
        "y": 1394.2344465255737,
        "wires": []
    },
    {
        "id": "3fbf62ba.04f2ee",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "852160e7.76eea"
        ],
        "x": 2032.2973327636719,
        "y": 2000.650046825409,
        "wires": []
    },
    {
        "id": "6a279f7e.a001b",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2031.9878997802734,
        "y": 2036.2691321372986,
        "wires": []
    },
    {
        "id": "d34aa50f.456728",
        "type": "link in",
        "z": "a18443b1.146f2",
        "name": "",
        "links": [
            "6a279f7e.a001b",
            "5494fb24.3819b4",
            "d679d327.0d02c",
            "ae63b58c.fce338",
            "87346430.699b98",
            "8847591d.796078",
            "834693.aaada97",
            "e02749aa.215db8",
            "eb39690b.259a08",
            "24930293.a7ab2e",
            "869a465b.fdfc48",
            "f3d3ff51.d9f3",
            "bb25c130.af7b4",
            "8368f72b.7cdb08",
            "d870166f.d9d648",
            "ea8b01d4.c3693",
            "8c3fed0f.05f9f"
        ],
        "x": 3494.978184223175,
        "y": 2122.836953163147,
        "wires": [
            [
                "acfa9534.156d98"
            ]
        ]
    },
    {
        "id": "5494fb24.3819b4",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2032.1069374084473,
        "y": 1965.5071997642517,
        "wires": []
    },
    {
        "id": "44ae657e.5f109c",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "31e315e.25d5dea"
        ],
        "x": 2033.1546325683594,
        "y": 2070.1580653190613,
        "wires": []
    },
    {
        "id": "ae63b58c.fce338",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2033.3768615722656,
        "y": 2104.1580653190613,
        "wires": []
    },
    {
        "id": "9a3f5dd5.63c6f",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "31e315e.25d5dea"
        ],
        "x": 2032.8879699707031,
        "y": 2140.2691493034363,
        "wires": []
    },
    {
        "id": "87346430.699b98",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2032.8879699707031,
        "y": 2175.2691493034363,
        "wires": []
    },
    {
        "id": "5ed04ade.9886d4",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "Topico Estado da Maquina",
        "topic": "fabrica/ihm/estado/",
        "qos": "0",
        "retain": "false",
        "broker": "d8f46f1a.2a7e2",
        "x": 3033.724189758301,
        "y": 1428.2139711380005,
        "wires": []
    },
    {
        "id": "39d211bf.6568be",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "Topico Estado da Maquina",
        "topic": "AplanadoraN/Estado",
        "qos": "0",
        "retain": "false",
        "broker": "d8f46f1a.2a7e2",
        "x": 2885.827739715576,
        "y": 1977.9123854637146,
        "wires": []
    },
    {
        "id": "cd209265.5e05e",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "Topico Estado da Maquina",
        "topic": "AplanadoraN/Estado",
        "qos": "0",
        "retain": "false",
        "broker": "d8f46f1a.2a7e2",
        "x": 2887.680244445801,
        "y": 2108.6265726089478,
        "wires": []
    },
    {
        "id": "81b07e20.d095a",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 100ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 100);\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2837.2560119628906,
        "y": 1928.4837679862976,
        "wires": [
            [
                "1dac4c45.62fc94"
            ]
        ]
    },
    {
        "id": "7b4d4c6c.1f9d14",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 500ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 500);\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 1746.255874633789,
        "y": 1417.2456822395325,
        "wires": [
            []
        ]
    },
    {
        "id": "e519962f.7b7098",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "Comandomaquina=0",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 2863.7799377441406,
        "y": 1826.102918624878,
        "wires": []
    },
    {
        "id": "d679d327.0d02c",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 3198.1727714538574,
        "y": 1934.5313792228699,
        "wires": []
    },
    {
        "id": "bfe3a0a9.67e07",
        "type": "switch",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina",
        "property": "ComandoMaquina",
        "propertyType": "global",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "2",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "3",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "4",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "5",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "6",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "7",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "8",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "9",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "10",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "11",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 12,
        "x": 2292.7558059692383,
        "y": 2103.9124612808228,
        "wires": [
            [
                "f66b5ac9.e4c648"
            ],
            [
                "49f23bfa.828b54"
            ],
            [
                "676d323b.9afe1c"
            ],
            [
                "7d7225ab.128e4c"
            ],
            [
                "ea4d52be.f85ff"
            ],
            [
                "20f901a.398b7fe"
            ],
            [
                "a42690fd.5406d"
            ],
            [
                "70ff7e57.1a941"
            ],
            [
                "516ef020.3baca"
            ],
            [
                "1807396b.8b92e7"
            ],
            [
                "df261a74.c0a168"
            ],
            [
                "e0331c45.7475b"
            ]
        ]
    },
    {
        "id": "2af0ca8e.6c7306",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3309.0895080566406,
        "y": 1909.579022884369,
        "wires": [
            []
        ]
    },
    {
        "id": "6e75a00f.d4a8a",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3315.017765045166,
        "y": 2041.9599566459656,
        "wires": [
            []
        ]
    },
    {
        "id": "676d323b.9afe1c",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Ligou motor?",
        "func": "//verifica 3.3 e libera 2.12\nvar mensagens = global.get(\"mensagens\");\nvar modbus = global.get(\"ModBus\");\nvar msg2 = {};\n\n\nif (((modbus[3]) & (1 << 3))) {//M3.3 igual a 1 ligando motor\n modbus[2] |= (1<<12);\n msg.payload = modbus[2];\n msg2.payload ={ type: 'info', message: 'Acelerando motor...' };\n msg2.payload.time= new Date();\n node.status({fill:\"green\",shape:\"dot\",text:\"Acelerando...\"});\n}else if (~((modbus[3]) & (1 << 3))){ // M3.3 igual a 0 Desliga motor\n modbus[2] &= ~(1<<12);\n msg.payload = modbus[2];\n msg2.payload ={ type: 'info', message: 'Desligando motor...' };\n msg2.payload.time= new Date();\n node.status({fill:\"yellow\",shape:\"ring\",text:\"Deslingado\"});\n}else {\n node.status({fill:\"red\",shape:\"ring\",text:\"Bug\"});\n}\n \nglobal.set('ModBus', modbus);//Atualiza registrador global\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2586.656047821045,
        "y": 2064.6457591056824,
        "wires": [
            [
                "a82a191c.83f1a8"
            ],
            [
                "cd209265.5e05e"
            ]
        ]
    },
    {
        "id": "a82a191c.83f1a8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 100ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 100);\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2837.255771636963,
        "y": 2058.579025745392,
        "wires": [
            [
                "bb8740fb.62e33"
            ]
        ]
    },
    {
        "id": "bb8740fb.62e33",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Desliga motor M2.12",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 3046.9225273132324,
        "y": 2058.24573469162,
        "wires": [
            [
                "6e75a00f.d4a8a"
            ],
            [
                "8847591d.796078"
            ]
        ]
    },
    {
        "id": "8847591d.796078",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 3203.5416679382324,
        "y": 2064.6743235588074,
        "wires": []
    },
    {
        "id": "f58cd64f.fad2e8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3317.7560234069824,
        "y": 2162.99573469162,
        "wires": [
            []
        ]
    },
    {
        "id": "7d7225ab.128e4c",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\" Aplanadora Abre M31.10\"});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2587.0060234069824,
        "y": 2167.99573469162,
        "wires": [
            [
                "f58cd64f.fad2e8"
            ]
        ]
    },
    {
        "id": "c3224f7c.6a557",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3318.2560234069824,
        "y": 2212.24573469162,
        "wires": [
            []
        ]
    },
    {
        "id": "ea4d52be.f85ff",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Aplanadora fecha M31.11\"});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2585.5060234069824,
        "y": 2215.99573469162,
        "wires": [
            [
                "c3224f7c.6a557"
            ]
        ]
    },
    {
        "id": "3332960c.3d002a",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "31e315e.25d5dea"
        ],
        "x": 2033.6784629821777,
        "y": 2210.369200706482,
        "wires": []
    },
    {
        "id": "834693.aaada97",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2034.1070518493652,
        "y": 2245.0834341049194,
        "wires": []
    },
    {
        "id": "f696e1b0.1467f",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "31e315e.25d5dea"
        ],
        "x": 2034.6784629821777,
        "y": 2281.2262563705444,
        "wires": []
    },
    {
        "id": "e02749aa.215db8",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2033.9642295837402,
        "y": 2316.369200706482,
        "wires": []
    },
    {
        "id": "20f901a.398b7fe",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\" Perfil Avança M2.3\"});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2588.3988723754883,
        "y": 2263.059998512268,
        "wires": [
            [
                "bc914b51.52e288"
            ]
        ]
    },
    {
        "id": "a42690fd.5406d",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"M2.4\"});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2587.8988723754883,
        "y": 2309.059998512268,
        "wires": [
            [
                "86a61665.075008"
            ]
        ]
    },
    {
        "id": "bc914b51.52e288",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3318.1132278442383,
        "y": 2260.059998512268,
        "wires": [
            []
        ]
    },
    {
        "id": "86a61665.075008",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3318.255928039551,
        "y": 2306.059989929199,
        "wires": [
            []
        ]
    },
    {
        "id": "650da0f0.57184",
        "type": "switch",
        "z": "a18443b1.146f2",
        "name": "i<7",
        "property": "i",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "1",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "2",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "3",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "4",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "5",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 7,
        "x": 2337.8949012756348,
        "y": 1281.2901372909546,
        "wires": [
            [
                "fd81bdf0.ae75d"
            ],
            [
                "343568e3.eacea8"
            ],
            [
                "58eb256a.87d74c"
            ],
            [
                "4f2f766e.e4f4a8"
            ],
            [
                "c3a5e03d.eb1bb"
            ],
            [
                "b4f46876.c44f18"
            ],
            [
                "326f161e.340d3a"
            ]
        ]
    },
    {
        "id": "5b8bfefc.12731",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "i++",
        "func": "msg.i++;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2478.7557983398438,
        "y": 1046.3734636306763,
        "wires": [
            [
                "650da0f0.57184"
            ]
        ]
    },
    {
        "id": "fd81bdf0.ae75d",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ALARMES E MENSAGENS HTML",
        "func": "var mensagens = global.get(\"mensagens\");\nvar modbus = msg.payload;\nvar msg2 ={\n //_msgid: msg._msgid,\n payload: msg.payload\n};\n\n//msg.payload = msg.i;\n\nif (msg2.payload[0] & (1 << 0)) {\n    msg2.payload = mensagens['EMERGENCIA'];\n} else if (msg2.payload[0] & (1 << 1)) {\n    msg2.payload = mensagens['FALTA_FASE'];\n} else if (msg2.payload[0] & (1 << 2)) {\n    msg2.payload = mensagens['BOMBA_HIDRAULICA'];\n} else if (msg2.payload[0] & (1 << 3)) {\n    msg2.payload = mensagens['MARTELO_PRENSA'];\n} else if (msg2.payload[0] & (1 << 4)) {\n    msg2.payload = mensagens['PRESSAO_AR'];\n} else if (msg2.payload[0] & (1 << 5)) {\n    msg2.payload = mensagens['INVERSOR'];\n} else if (msg2.payload[0] & (1 << 6)) {\n    msg2.payload = mensagens['SERVO'];\n} else if ((msg2.payload[0] & (1 << 7)))/*||(msg.payload[2] &= ~(1 << 11)))*/ {\n    msg2.payload = mensagens['CHAVE_GERAL_DESLIGADA'];\n} else if (msg2.payload[0] & (1 << 9)) {\n    msg2.payload = mensagens['ERRO_POSICIONAMENTO'];\n} else if (msg2.payload[0] & (1 << 10)) {\n    msg2.payload = mensagens['SEGURAN_PRENSA'];\n} else if (msg2.payload[1] & (1 << 12)) {\n    msg2.payload = mensagens['APLAN_ABERTA'];\n} else if (msg2.payload[0] & (1 << 8)) {\n    msg2.payload = mensagens['MAQUINA_NAO_LIBERADA'];\n} else {\n    if((global.get(\"MotorInvertido\"))==1){\n        msg2.payload = { type: 'info', message: ' Motor Invertido!!!'};\n    }else{\n        msg2.payload = { type: 'info', message: ' Maquina OK'};\n    }\n}\n\nmsg2.payload.time= new Date();\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2612.436420440674,
        "y": 1172.8734865188599,
        "wires": [
            [
                "5b8bfefc.12731"
            ],
            [
                "5ed04ade.9886d4",
                "2e6bf63b.2d1cda"
            ]
        ]
    },
    {
        "id": "a19b0602.047a28",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "loop leitura i=0",
        "func": "global.set(\"ModBus\",msg.payload);\nmsg.i =0;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2160.2281494140625,
        "y": 1281.095736503601,
        "wires": [
            [
                "650da0f0.57184"
            ]
        ]
    },
    {
        "id": "343568e3.eacea8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "APLANADORA FECHADA HTML",
        "func": "var msg2 ={\n //_msgid: msg._msgid,\n payload: global.get(\"ModBus\")\n};\n\n//msg.payload = msg.i;\n\nif (msg2.payload[1] & (1 << 12)) {\n    msg2= {\n        payload: {APLANADORA_FECHADA:0}\n    };\n } else{\n    msg2= {\n        payload: {APLANADORA_FECHADA:1}\n    };\n }\n\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2612.536636352539,
        "y": 1208.6680727005005,
        "wires": [
            [
                "5b8bfefc.12731"
            ],
            [
                "5ed04ade.9886d4"
            ]
        ]
    },
    {
        "id": "58eb256a.87d74c",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ATUALIZA MAQ LIGADA HTML",
        "func": "var msg2 ={\n //_msgid: msg._msgid,\n payload: global.get(\"ModBus\")\n};\n\n//msg.payload = msg.i;\nif (msg2.payload[2] & (1 << 11 )) {\n    msg2= {\n        payload: {MAQUINA_ON:1}\n    };\n} else{\n    msg2= {\n        payload: {MAQUINA_ON:0}\n    };\n}\n\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2602.033576965332,
        "y": 1245.9012565612793,
        "wires": [
            [
                "5b8bfefc.12731"
            ],
            [
                "5ed04ade.9886d4"
            ]
        ]
    },
    {
        "id": "326f161e.340d3a",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Loop Finished",
        "func": "msg.payload=global.get(\"ModBus\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2552.3670806884766,
        "y": 1394.1234917640686,
        "wires": [
            [
                "197a0380.cfa65d"
            ]
        ]
    },
    {
        "id": "197a0380.cfa65d",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 300ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 300);\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2720.656005859375,
        "y": 1393.8790616989136,
        "wires": [
            [
                "996aeb43.46e098"
            ]
        ]
    },
    {
        "id": "1fb5540b.dd923c",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2718.6275177001953,
        "y": 1484.2219228744507,
        "wires": [
            [
                "5ed04ade.9886d4",
                "85920b3e.c2ca78"
            ]
        ]
    },
    {
        "id": "5afb7349.652eec",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Liga Chave Geral e Libera a Maquina",
        "info": "#test\n- nao\n- sei\n- onde v\n- vai \n- parar\n- isso",
        "x": 2662.14493560791,
        "y": 1892.9012441635132,
        "wires": []
    },
    {
        "id": "e87e3756.028bb8",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Liga / Deslig Motor",
        "info": "#test\n- nao\n- sei\n- onde v\n- vai \n- parar\n- isso",
        "x": 2605.8117141723633,
        "y": 2022.901291847229,
        "wires": []
    },
    {
        "id": "914db1f5.a9548",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Envia para fila qualquer erro na comunicação",
        "info": "#test\n- nao\n- sei\n- onde v\n- vai \n- parar\n- isso",
        "x": 3708.5893020629883,
        "y": 2084.901291847229,
        "wires": []
    },
    {
        "id": "2f06c4e8.b216ec",
        "type": "mongodb in",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "consulta",
        "collection": "parametros",
        "operation": "find",
        "x": 650.8709259033203,
        "y": 2637.492778301239,
        "wires": [
            [
                "b45967b7.910b68"
            ]
        ]
    },
    {
        "id": "e6aa2e6c.c8597",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "lê apenas 1 parametro",
        "func": "// Para ler um registro primeiro especificar \"_id\" no payload\nmsg.payload = { \"_id\": \"AplanadoraN3\" }\n\n// No parametro projection 1 ou zero significa ler ou inguinorar resultado\nmsg.projection = { \"parametros.encoder.fator\": 1 }\n\n// Ler 1 valor\nmsg.limit = 1;\n\n// Pular 0 resultados\nmsg.skip = 0;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 437.9819965362549,
        "y": 2637.3298087120056,
        "wires": [
            [
                "2f06c4e8.b216ec"
            ]
        ]
    },
    {
        "id": "394a14fb.73b97c",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 217.99590682983398,
        "y": 2636.9927592277527,
        "wires": [
            [
                "e6aa2e6c.c8597"
            ]
        ]
    },
    {
        "id": "b45967b7.910b68",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "parse(fator encoder)",
        "func": "msg.payload=msg.payload[0].parametros.encoder.fator;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 844.0377426147461,
        "y": 2637.909477710724,
        "wires": [
            [
                "4eb1a897.68d298"
            ]
        ]
    },
    {
        "id": "4eb1a897.68d298",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "ler registrador x",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1050.3711624145508,
        "y": 2637.9093585014343,
        "wires": []
    },
    {
        "id": "a22bb80b.ff5408",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Lê apenas um valor",
        "info": "#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ",
        "x": 223.20395851135254,
        "y": 2601.9094185829163,
        "wires": []
    },
    {
        "id": "c296f4a3.d359f8",
        "type": "mongodb in",
        "z": "a18443b1.146f2",
        "mongodb": "4e844c3e.6f0704",
        "name": "consulta",
        "collection": "parametros",
        "operation": "find",
        "x": 3181.8897552490234,
        "y": 1543.5901250839233,
        "wires": [
            [
                "41a1703.3b3649",
                "c5cf53cd.6d9d3"
            ]
        ]
    },
    {
        "id": "85920b3e.c2ca78",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Paginação ",
        "func": "msg.limit = 5;\nmsg.skip = 0;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2982.000825881958,
        "y": 1543.42715549469,
        "wires": [
            [
                "c296f4a3.d359f8",
                "9df0e9dd.545ba8"
            ]
        ]
    },
    {
        "id": "6d97584.b105ca8",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Carrega valores iniciais do banco",
        "info": "#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ",
        "x": 3040.278694152832,
        "y": 1508.5290079116821,
        "wires": []
    },
    {
        "id": "41a1703.3b3649",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Carrega todos os parametros",
        "func": "//Cria um array vazio\nvar parametros = [];\n\nparametros.push(msg.payload[0].parametros.velocidade.automatico); //AplanVelAuto M14\nparametros.push(msg.payload[0].parametros.velocidade.manual); //AplanVelMan M17\nparametros.push(msg.payload[0].parametros.ferramenta.passo); //AplanPasso M18\nparametros.push(msg.payload[0].parametros.encoder.fator); //EncFactor M20\nparametros.push(msg.payload[0].parametros.encoder.resolucao); //EncResol M21 \nparametros.push(msg.payload[0].parametros.encoder.perimetro); //EncPerim M22\nparametros.push(msg.payload[0].lubrificacao.ciclos.PrsCiclosUnid); //PrsCiclosUnid M23\nparametros.push(msg.payload[0].lubrificacao.ciclos.PrsCiclosMil); //PrsCiclosMil M24\nparametros.push(msg.payload[0].lubrificacao.preset.MbNovoCiclosUnd);//NovoPrsCiclosUnd M25\nparametros.push(msg.payload[0].lubrificacao.preset.MbNovoCiclosmil);//NovoCiclosMil M26\n\n//Salva em uma variavel externa ao bloco\nflow.set('params', parametros); \n\n//Envia o conteudo do array para o proximo bloco\nmsg.payload = parametros;\n\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Parametros Carregados\"});\nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 3397.945037841797,
        "y": 1543.279074668884,
        "wires": [
            [
                "8f2edad5.414508",
                "fc7ae0cf.37123",
                "6cedfc03.938524"
            ]
        ]
    },
    {
        "id": "8f2edad5.414508",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "Array completo",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 3674.0637741088867,
        "y": 1686.0411443710327,
        "wires": []
    },
    {
        "id": "fc7ae0cf.37123",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "tamanho",
        "active": false,
        "console": "false",
        "complete": "payload.length",
        "x": 3651.7305908203125,
        "y": 1645.5169801712036,
        "wires": []
    },
    {
        "id": "6cedfc03.938524",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Separa cada mensagem",
        "func": "var msgs = [null, null, null, null, null, null, null, null, null, null];\n\nmsgs[flow.get('params').length - 1] = {payload: flow.get('params')[flow.get('params').length - 1]};\n\nnode.send(msgs);\n",
        "outputs": "10",
        "noerr": 0,
        "x": 3698.6918716430664,
        "y": 1544.3615274429321,
        "wires": [
            [
                "1ed252a6.be0dad",
                "5198eae.01a9a14"
            ],
            [
                "a55c8348.1af8e"
            ],
            [
                "807f5847.12c668"
            ],
            [
                "f9d357d8.13bfb8"
            ],
            [
                "39d40110.c667ae"
            ],
            [
                "38eb002c.a551e"
            ],
            [
                "14eda4b0.dd3d6b"
            ],
            [
                "59713adb.b05e74"
            ],
            [
                "eccb5959.590808"
            ],
            [
                "7575a5cc.f011ac"
            ]
        ]
    },
    {
        "id": "eb39690b.259a08",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 4246.382514953613,
        "y": 1830.9648599624634,
        "wires": []
    },
    {
        "id": "ab2fe060.79b78",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "LOOP DE ESCRITA",
        "func": "//Somente entra aqui se o array ainda for >= 0\nif (flow.get('params').length >= 0) {\n \n // Carrega todos os parametros que ainda não foram enviados\n var params = flow.get('params');\n \n // Cria um novo Array tirando o ultimo elemento\n var novo = params.slice(0, flow.get('params').length - 1);\n \n // Sobrescreve o arry params\n flow.set('params', novo);\n \n // Envia novo array com -1 elemento\n msg.payload = novo;\n return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 3691.0180130004883,
        "y": 1353.6790628433228,
        "wires": [
            [
                "6cedfc03.938524"
            ]
        ]
    },
    {
        "id": "5ace7b3c.18e5c4",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "LOOP",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 3640.4782180786133,
        "y": 1395.5679483413696,
        "wires": []
    },
    {
        "id": "1ed252a6.be0dad",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "AplanVelAuto_M14",
        "dataType": "HoldingRegister",
        "adr": "14",
        "server": "357d20ae.edfc8",
        "x": 4020.478271484375,
        "y": 1355.1789817810059,
        "wires": [
            [
                "83d1ab20.226cf8",
                "e1033815.04fd18"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "39d40110.c667ae",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "EncResol_M21",
        "dataType": "HoldingRegister",
        "adr": "21",
        "server": "357d20ae.edfc8",
        "x": 4012.049732208252,
        "y": 1547.6075677871704,
        "wires": [
            [
                "83d1ab20.226cf8",
                "753957a9.806f58"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "807f5847.12c668",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "AplanPasso_M18",
        "dataType": "HoldingRegister",
        "adr": "18",
        "server": "357d20ae.edfc8",
        "x": 4022.620948791504,
        "y": 1452.3219203948975,
        "wires": [
            [
                "83d1ab20.226cf8",
                "b3ec43a.03b9ac"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "a55c8348.1af8e",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "AplanVelMan_M17",
        "dataType": "HoldingRegister",
        "adr": "17",
        "server": "357d20ae.edfc8",
        "x": 4021.7638931274414,
        "y": 1403.3219203948975,
        "wires": [
            [
                "83d1ab20.226cf8",
                "c4919185.05402"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "f9d357d8.13bfb8",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "EncFactor_M20",
        "dataType": "HoldingRegister",
        "adr": "20",
        "server": "357d20ae.edfc8",
        "x": 4011.621021270752,
        "y": 1501.036156654358,
        "wires": [
            [
                "83d1ab20.226cf8",
                "17588c99.3b0a03"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "7575a5cc.f011ac",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "NovoCiclosMil_M26",
        "dataType": "HoldingRegister",
        "adr": "26",
        "server": "357d20ae.edfc8",
        "x": 4032.478199005127,
        "y": 1790.178978919983,
        "wires": [
            [
                "83d1ab20.226cf8",
                "77ff663c.44a898"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "14eda4b0.dd3d6b",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "PrsCiclosUnid_M27",
        "dataType": "HoldingRegister",
        "adr": "27",
        "server": "357d20ae.edfc8",
        "x": 4023.049415588379,
        "y": 1648.89333152771,
        "wires": [
            [
                "83d1ab20.226cf8",
                "bc704e2e.0379a"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "38eb002c.a551e",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "EncPerim_M22",
        "dataType": "HoldingRegister",
        "adr": "22",
        "server": "357d20ae.edfc8",
        "x": 4012.1923599243164,
        "y": 1597.89333152771,
        "wires": [
            [
                "83d1ab20.226cf8",
                "4ada60.8d3a15a"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "eccb5959.590808",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "NovoPrsCiclosUnd_M25",
        "dataType": "HoldingRegister",
        "adr": "25",
        "server": "357d20ae.edfc8",
        "x": 4042.049488067627,
        "y": 1740.6075677871704,
        "wires": [
            [
                "83d1ab20.226cf8",
                "b78f54ad.48aac8"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "59713adb.b05e74",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "PrsCiclosMil_M28",
        "dataType": "HoldingRegister",
        "adr": "28",
        "server": "357d20ae.edfc8",
        "x": 4023.2560501098633,
        "y": 1694.6790628433228,
        "wires": [
            [
                "83d1ab20.226cf8",
                "a6104146.016f7"
            ],
            [
                "eb39690b.259a08"
            ]
        ]
    },
    {
        "id": "8d85fe47.e9bab",
        "type": "link in",
        "z": "a18443b1.146f2",
        "name": "loop escrita",
        "links": [
            "83d1ab20.226cf8"
        ],
        "x": 3346.7560501098633,
        "y": 1353.6457376480103,
        "wires": [
            [
                "c13e6856.7a71d8"
            ]
        ]
    },
    {
        "id": "83d1ab20.226cf8",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "loop inicializando CLP",
        "links": [
            "8d85fe47.e9bab"
        ],
        "x": 4255.756050109863,
        "y": 1315.945725440979,
        "wires": []
    },
    {
        "id": "c13e6856.7a71d8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 100ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 100);\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 3452.7560501098633,
        "y": 1353.5957498550415,
        "wires": [
            [
                "5ace7b3c.18e5c4",
                "ab2fe060.79b78"
            ]
        ]
    },
    {
        "id": "316b442e.7142cc",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "Topico Regitradores da Maquina",
        "topic": "AplanadoraN/registradores",
        "qos": "0",
        "retain": "false",
        "broker": "d8f46f1a.2a7e2",
        "x": 4858.732460021973,
        "y": 1548.2980470657349,
        "wires": []
    },
    {
        "id": "5bc847e6.3b7b28",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Grava valor dos registradores no CLP",
        "info": "A cada inicialização os valores dos registradores são atualizados a partir de MongoDB:\n\n1- AplanVelAuto M14\nVelocidade maxima no automatico de 0% a 100%\n\n2- AplanVelMan M17\nVelocidade maxima no manual de 0% a 100%\n\n3- AplanPasso M18\nPasso da ferramenta em \"mm\", de 0 a 400mm\n\n4- EncFactor M20\nFator de correção do encoder em numeros inteiros apenas.\n\n5- EncResol M21\nResolução do encoder em numeros inteiros apenas. 1 a 10000\n\n6- EncPerim M22\nPerimetro do encoder em \"mm\". De 1 a 999\n\n7- PrsCiclosUnid M23\nCiclos de Lubrificação da prensa. De 0 a 65534 unidades\n\n8- PrsCiclosMil M24\nCiclos de Lubrificação da prensa vezes 1000. De 0 a 65534 unidades\n\n9- NovoPrsCiclosUnd M25\nCiclos que faltam para proxima Lubrificação da prensa. De 0 a 65534 unidades\n\n10- NovoCiclosMil M26\nCiclos que faltam para proxima Lubrificação da prensa vezes 1000. De 0 a 65534 unidades\n\n",
        "x": 4025.9225540161133,
        "y": 1316.0124063491821,
        "wires": []
    },
    {
        "id": "e1033815.04fd18",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M14 na pagina",
        "func": "var valor = msg.payload;\n\nmsg.payload = {\n AplanVelAuto: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n\n \nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4404.255882263184,
        "y": 1354.9171934127808,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "c4919185.05402",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M17 na pagina",
        "func": "var valor = msg.payload;\n\nmsg.payload = {\n AplanVelMan: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n \nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4403.113227844238,
        "y": 1403.4886026382446,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "17588c99.3b0a03",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M20 na pagina",
        "func": "var valor = msg.payload;\n\nglobal.set(\"FatorEncoder\",valor);\nmsg.payload = {\n EncFactor: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n \nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4402.113227844238,
        "y": 1501.2029275894165,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "b3ec43a.03b9ac",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M18 na pagina",
        "func": "var valor = msg.payload;\n\nmsg.payload = {\n AplanPasso: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4403.255882263184,
        "y": 1451.6315183639526,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "bc704e2e.0379a",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M27 na pagina",
        "func": "var valor = msg.payload;\n\nmsg.payload = {\n PrsCiclosUnid: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n \nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4400.970405578613,
        "y": 1647.3457498550415,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "4ada60.8d3a15a",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M22 na pagina",
        "func": "var valor = msg.payload;\n\nmsg.payload = {\n EncPerim: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4402.113059997559,
        "y": 1597.7743406295776,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "753957a9.806f58",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M21 na pagina",
        "func": "var valor = msg.payload;\n\nmsg.payload = {\n EncResol: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4401.970405578613,
        "y": 1549.6314249038696,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "77ff663c.44a898",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M26 na pagina",
        "func": "var valor = msg.payload;\n\nmsg.payload = {\n NovoCiclosMil: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:\"falta implementar\"});\n \nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4400.113227844238,
        "y": 1791.2029275894165,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "b78f54ad.48aac8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M25 na pagina",
        "func": "var valor = msg.payload;\n\nmsg.payload = {\n NovoPrsCiclosUnd: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n \nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4401.255882263184,
        "y": 1741.6315183639526,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "a6104146.016f7",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza M28 na pagina",
        "func": "var valor = msg.payload;\n\nmsg.payload = {\n PrsCiclosMil: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:(\"Valor x1000 = \"+ valor)});\n\nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 4401.113227844238,
        "y": 1693.4886026382446,
        "wires": [
            [
                "316b442e.7142cc"
            ]
        ]
    },
    {
        "id": "c5cf53cd.6d9d3",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "consulta",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 3339.3275833129883,
        "y": 1499.417290687561,
        "wires": []
    },
    {
        "id": "55a6fc9e.121054",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Atualiza MongoDB",
        "func": "var parametro = JSON.parse(msg.payload);\n\n/****** APLANADORA VELOCIDADE AUTOMATICA M14 *********/\nif (parametro.AplanVelAuto_KEYBOARD !== undefined) {\n var x = parametro.AplanVelAuto_KEYBOARD;\n msg.query = { _id: 'AplanadoraN3' }\n msg.payload = {\n $set: {\n \"parametros.velocidade.automatico\": x\n }\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"Velocidade Auto = \"+ x)});\n return msg;\n}\n\n/****** APLANADORA VELOCIDADE MANUAL M17 *********/\nif (parametro.AplanVelMan_KEYBOARD !== undefined) {\n var x = parametro.AplanVelMan_KEYBOARD;\n msg.query = { _id: 'AplanadoraN3' }\n msg.payload = {\n $set: {\n \"parametros.velocidade.manual\": x\n }\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"Velocidade Manual = \"+ x)});\n return msg;\n}\n\n/****** APLANADORA PASSO M18 *********/\nif (parametro.AplanPasso_KEYBOARD !== undefined) {\n var x = parametro.AplanPasso_KEYBOARD;\n msg.query = { _id: 'AplanadoraN3' }\n msg.payload = {\n $set: {\n \"parametros.ferramenta.passo\": x\n }\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"Passo = \"+ x)});\n return msg;\n}\n\n/****** FATOR DE ENCONDER M20*********/\nif (parametro.EncFactor_KEYBOARD !== undefined) {\n var x = parametro.EncFactor_KEYBOARD;\n msg.query = { _id: 'AplanadoraN3' }\n msg.payload = {\n $set: {\n \"parametros.encoder.fator\": x\n }\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"fator = \"+ x)});\n return msg;\n}\n\n/****** RESOLUÇÃO DO ENCONDER M21 *********/\nif (parametro.EncResol_KEYBOARD !== undefined) {\n var x = parametro.EncResol_KEYBOARD;\n msg.query = { _id: 'AplanadoraN3' }\n msg.payload = {\n $set: {\n \"parametros.encoder.resolucao\": x\n }\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"Resolução ENC = \"+ x)});\n return msg;\n}\n\n/****** PERIMETRO DO ENCONDER M22 *********/\nif (parametro.EncPerim_KEYBOARD !== undefined) {\n var x = parametro.EncPerim_KEYBOARD;\n msg.query = { _id: 'AplanadoraN3' }\n msg.payload = {\n $set: {\n \"parametros.encoder.perimetro\": x\n }\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"Perimetro ENC = \"+ x)});\n return msg;\n}\n\n/****** TamanhoDesejadoPeca Campo da pagina *********/\nif (parametro.TamanhoDesejadoPeca_KEYBOARD !== undefined) {\n var x = (parametro.TamanhoDesejadoPeca_KEYBOARD||0);\n if ((x>=2)&&(x<=20000)){\n global.set('TamanhoDesejadoPeca_KEYBOARD', x);\n }else {\n x=0;\n global.set('TamanhoDesejadoPeca_KEYBOARD', 0);\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"Tamanho Desejado = \"+ x)});\n}\n\n/****** TamanhoRealPeca Campo da pagina *********/\nif (parametro.TamanhoRealPeca_KEYBOARD !== undefined) {\n var x = (parametro.TamanhoRealPeca_KEYBOARD||0);\n if ((x>=2)&&(x<=20000)){\n global.set('TamanhoRealPeca_KEYBOARD', x);\n }else {\n x=0;\n global.set('TamanhoRealPeca_KEYBOARD', 0);\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"Tamanho Real = \"+ x)});\n}\n\n/****** RecalcularFator e grava no banco *********/\nif (parametro.RecalcularFator !== undefined) {\n var x = (global.get('TamanhoRealPeca_KEYBOARD')||0);\n var y = (global.get('TamanhoDesejadoPeca_KEYBOARD')||0);\n if ((x!==0)&&(y!==0)){\n var z = x/y;\n z *= (global.get('FatorEncoder')/10000);\n var z2 = Math.round(z*10000);\n msg.query = { _id: 'AplanadoraN3' }\n msg.payload = {\n $set: {\n \"parametros.encoder.fator\": z2\n }\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"Calculado Fator ENC = \"+ z2)});\n return msg;\n }\n}\n\n/****** Atualiza numero de cilcos da prensa e grava no banco ********/\nif ((parametro.PrsCiclosUnid_KEYBOARD !== undefined )||(parametro.PRENSA_CICLOS !== undefined) ) {\n msg.query = { _id: 'AplanadoraN3' }\n msg.payload = {\n $set: {\n \"lubrificacao.ciclos.PrsCiclosUnid\": parametro.PrsCiclosUnid_KEYBOARD\n }\n }\n node.status({fill:\"blue\",shape:\"dot\",text:(\"Ciclos = \"+ parametro.PrsCiclosUnid_KEYBOARD)});\n return msg;\n}\n\n/* FALTA FAZER*************\nPrsCiclosUnid M23\nPrsCiclosMil M24\nNovoPrsCiclosUnd M25\nNovoCiclosMil M26*/\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 2440.612895965576,
        "y": 1599.7028760910034,
        "wires": [
            [
                "7c99aa2e.b4f6e4",
                "702271f4.ace6a",
                "2fcd60de.93481"
            ]
        ]
    },
    {
        "id": "7c99aa2e.b4f6e4",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "4e844c3e.6f0704",
        "name": "salvar",
        "collection": "parametros",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "update",
        "x": 2702.612861633301,
        "y": 1599.769546508789,
        "wires": []
    },
    {
        "id": "76995798.a75ec8",
        "type": "mqtt in",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "AplanadoraN/registradores",
        "qos": "0",
        "broker": "d8f46f1a.2a7e2",
        "x": 2169.7086753845215,
        "y": 1649.980471611023,
        "wires": [
            [
                "55a6fc9e.121054",
                "5b75fdd9.3d2c04"
            ]
        ]
    },
    {
        "id": "b49c991a.019df8",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Save the modified values in the bank",
        "info": "#Whats is saved until now!\n\nAfter one JSON.parse(msg.payload);\n\nAPLANADORA VELOCIDADE AUTOMATICA M14\nAPLANADORA VELOCIDADE MANUAL M17\nAPLANADORA PASSO M18\nRESOLUÇÃO DO ENCONDER M21",
        "x": 2444.776008605957,
        "y": 1559.1116132736206,
        "wires": []
    },
    {
        "id": "702271f4.ace6a",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "Salvou",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 2702.0416946411133,
        "y": 1652.7028970718384,
        "wires": []
    },
    {
        "id": "2fcd60de.93481",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 300ms",
        "func": "setTimeout(function() {\n msg= {payload: \"{MAQUINA_OFF:0}\"};\n node.send(msg);\n}, 300);\n\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2719.0656509399414,
        "y": 1542.226731300354,
        "wires": [
            [
                "7f124b74.5cca34",
                "85920b3e.c2ca78"
            ]
        ]
    },
    {
        "id": "7f124b74.5cca34",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "depois de salvar",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 2980.808906555176,
        "y": 1601.8722696304321,
        "wires": []
    },
    {
        "id": "5b75fdd9.3d2c04",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "fila",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 2401.0786628723145,
        "y": 1649.5865964889526,
        "wires": []
    },
    {
        "id": "f63cd1d4.5df32",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "board/setup",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1442.4641075134277,
        "y": 2181.1548252105713,
        "wires": []
    },
    {
        "id": "533dc177.941ae",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "Leitura PLC",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 2150.0416946411133,
        "y": 1353.1314859390259,
        "wires": []
    },
    {
        "id": "6ad0c41f.2e1dcc",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "loop6",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 3267.3830184936523,
        "y": 1241.2401695251465,
        "wires": []
    },
    {
        "id": "4f2f766e.e4f4a8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ATUALIZA MAQ ERRO POS HTML",
        "func": "//M19\nvar msg2 ={ payload: global.get(\"ModBus\")};\n\nmsg2 = {\n payload: {ERRO_POS: msg2.payload[19]}\n};\n\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2612.2560501098633,
        "y": 1281.4624185562134,
        "wires": [
            [
                "5b8bfefc.12731"
            ],
            [
                "5ed04ade.9886d4"
            ]
        ]
    },
    {
        "id": "c3a5e03d.eb1bb",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ATUALIZA MAQ POS ATUAL HTML",
        "func": "//M5\nvar msg2 ={ payload: global.get(\"ModBus\")};\n\nmsg2= {\n payload:{POS_ATUAL: msg2.payload[5]}\n};\n\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2621.2560501098633,
        "y": 1319.4624185562134,
        "wires": [
            [
                "5b8bfefc.12731"
            ],
            [
                "5ed04ade.9886d4"
            ]
        ]
    },
    {
        "id": "b4f46876.c44f18",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ATUALIZA MAQ",
        "func": "//M5\nvar msg2 ={ payload: global.get(\"ModBus\")};\n\nvar ciclos = msg2.payload[23];\nvar Mciclos =((1000)*(msg2.payload[24]));\n\nmsg2= {\n    payload:{ PRENSA_CICLOS:(ciclos+Mciclos)\n    }\n};\n\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2551.5560989379883,
        "y": 1357.1624307632446,
        "wires": [
            [
                "5b8bfefc.12731"
            ],
            [
                "5ed04ade.9886d4"
            ]
        ]
    },
    {
        "id": "2dfad676.8b261a",
        "type": "delay",
        "z": "a18443b1.146f2",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2198.7060623168945,
        "y": 1483.745774269104,
        "wires": [
            [
                "fb8c3b6e.b213c8"
            ]
        ]
    },
    {
        "id": "e9ba66cf.0fb248",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Modo Auto M2.0 ON/OFF",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 1869.3045616149902,
        "y": 2511.150008201599,
        "wires": [
            [
                "b4a4312e.324d5"
            ],
            [
                "24930293.a7ab2e"
            ]
        ]
    },
    {
        "id": "70ff7e57.1a941",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Parar Maquina\"});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2588.106025695801,
        "y": 2366.4124002456665,
        "wires": [
            [
                "e40e49b2.c04e88"
            ]
        ]
    },
    {
        "id": "516ef020.3baca",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"M31.11\"});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2586.606025695801,
        "y": 2444.4124002456665,
        "wires": [
            [
                "5f01ce50.12b87"
            ]
        ]
    },
    {
        "id": "1807396b.8b92e7",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Produzir\"});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2589.4988746643066,
        "y": 2491.4766640663147,
        "wires": [
            [
                "f74520ee.b9062"
            ]
        ]
    },
    {
        "id": "e0331c45.7475b",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms Desbobinador",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Desbobinador\"});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2638.9988746643066,
        "y": 2662.4766640663147,
        "wires": [
            [
                "4a21bb0b.344134"
            ]
        ]
    },
    {
        "id": "17d3bae7.226b05",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3318.7228469848633,
        "y": 2353.1123514175415,
        "wires": [
            []
        ]
    },
    {
        "id": "5f01ce50.12b87",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3319.2228469848633,
        "y": 2444.3623514175415,
        "wires": [
            []
        ]
    },
    {
        "id": "2ba49faf.286a8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3319.080051422119,
        "y": 2485.1766152381897,
        "wires": [
            []
        ]
    },
    {
        "id": "4a21bb0b.344134",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3319.2227516174316,
        "y": 2663.176606655121,
        "wires": [
            []
        ]
    },
    {
        "id": "b4a4312e.324d5",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "852160e7.76eea"
        ],
        "x": 2031.3713340759277,
        "y": 2497.1000204086304,
        "wires": []
    },
    {
        "id": "24930293.a7ab2e",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2031.0619010925293,
        "y": 2532.71910572052,
        "wires": []
    },
    {
        "id": "f74520ee.b9062",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Muda MbMaquinaProduzindo M1.7",
        "func": "//*****MbMaquinaProduzindo M1.7\nvar modbus = global.get(\"ModBus\");\n \nif ((modbus[2]) & (1 << 0)) {\n modbus[1] &= ~(1<<7); //M1.7 igual a 1 produzir\n node.status({fill:\"red\",shape:\"dot\",text:\"M1.7 = OFF\"});\n} else {\n modbus[1] |= (1<<7);//M1.7 igual a 0 não produzir\n node.status({fill:\"green\",shape:\"ring\",text:\"M1.7 = ON\"});\n}\nglobal.set(\"ComandoMaquina\",9);\nglobal.set('ModBus', modbus);//Atualiza registrador global.\nmsg.payload = modbus[1];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2835.7060012817383,
        "y": 2491.7791604995728,
        "wires": [
            [
                "47710d1a.a5b654"
            ]
        ]
    },
    {
        "id": "47710d1a.a5b654",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Modo Auto M1.7",
        "dataType": "HoldingRegister",
        "adr": "1",
        "server": "357d20ae.edfc8",
        "x": 3081.7394485473633,
        "y": 2492.4624490737915,
        "wires": [
            [
                "2ba49faf.286a8"
            ],
            [
                "869a465b.fdfc48"
            ]
        ]
    },
    {
        "id": "869a465b.fdfc48",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 3244.722724914551,
        "y": 2526.4625101089478,
        "wires": []
    },
    {
        "id": "26ecf631.2047ba",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "MbPrsParar M2.13 & 2.0",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 1866.3378715515137,
        "y": 2369.849892616272,
        "wires": [
            [
                "ebf93874.b9f548"
            ],
            [
                "f3d3ff51.d9f3"
            ]
        ]
    },
    {
        "id": "ebf93874.b9f548",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "852160e7.76eea"
        ],
        "x": 2033.404598236084,
        "y": 2351.799910545349,
        "wires": []
    },
    {
        "id": "f3d3ff51.d9f3",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2033.0951499938965,
        "y": 2386.419051170349,
        "wires": []
    },
    {
        "id": "65ff54ca.103bdc",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Modo Auto M2.0 OFF",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 1859.771297454834,
        "y": 2437.8500204086304,
        "wires": [
            [
                "893ab752.717988"
            ],
            [
                "bb25c130.af7b4"
            ]
        ]
    },
    {
        "id": "893ab752.717988",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "852160e7.76eea"
        ],
        "x": 2032.8380699157715,
        "y": 2423.8000326156616,
        "wires": []
    },
    {
        "id": "bb25c130.af7b4",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2031.528636932373,
        "y": 2459.4191179275513,
        "wires": []
    },
    {
        "id": "79ca2f6b.66bb4",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "31e315e.25d5dea"
        ],
        "x": 1775.3380088806152,
        "y": 2727.2001180648804,
        "wires": []
    },
    {
        "id": "e40e49b2.c04e88",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Parar motor",
        "func": "//muda 3.3\nvar mensagens = global.get(\"mensagens\");\nvar modbus = global.get(\"ModBus\");\nvar msg2 = {};\n\n// M3.3 igual a 0 Desliga motor\n modbus[2] &= ~(1<<12);\n msg.payload = modbus[2];\n msg2.payload ={ type: 'info', message: 'Desligando motor para reverter...' };\n msg2.payload.time= new Date();\n node.status({fill:\"yellow\",shape:\"ring\",text:\"Deslingado\"});\n\nglobal.set(\"MotorLigado\",0);\nglobal.set('ModBus', modbus);//Atualiza registrador global\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2770.3810501098633,
        "y": 2366.949875831604,
        "wires": [
            [
                "69e9d20f.a3edfc"
            ],
            [
                "5293145a.09eb1c"
            ]
        ]
    },
    {
        "id": "5293145a.09eb1c",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "Topico Estado da Maquina",
        "topic": "AplanadoraN/Estado",
        "qos": "0",
        "retain": "false",
        "broker": "d8f46f1a.2a7e2",
        "x": 3039.8810501098633,
        "y": 2409.699875831604,
        "wires": []
    },
    {
        "id": "69e9d20f.a3edfc",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Desliga motor M2.12",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 3020.6310501098633,
        "y": 2359.949875831604,
        "wires": [
            [
                "17d3bae7.226b05"
            ],
            [
                "8368f72b.7cdb08"
            ]
        ]
    },
    {
        "id": "8368f72b.7cdb08",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 3244.3810501098633,
        "y": 2399.199875831604,
        "wires": []
    },
    {
        "id": "d2c8d14b.d6c49",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "indice +1",
        "func": "//Carrega variavel global indice em y\nvar y = global.get(\"Indice_Mongo\");\n\n//monta a mensagem\nmsg.query = { _id: 'indice' };\nmsg.payload = {\n $set: {\"indice_mesagens\": parseInt(y)}\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 3286.302261352539,
        "y": 1108.0879850387573,
        "wires": [
            [
                "e678f79a.f82188"
            ]
        ]
    },
    {
        "id": "e678f79a.f82188",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "4e844c3e.6f0704",
        "name": "Atualizar Indice",
        "collection": "indice",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "update",
        "x": 3460.016311645508,
        "y": 1108.4380807876587,
        "wires": []
    },
    {
        "id": "9127d2f0.e0b5b",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "Read indice",
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 2775.8383255004883,
        "y": 1716.2769327163696,
        "wires": [
            [
                "8e73b212.de599"
            ]
        ]
    },
    {
        "id": "a2044bcb.cde0b8",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "indice",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 3643.2985763549805,
        "y": 1726.9752922058105,
        "wires": []
    },
    {
        "id": "2e6bf63b.2d1cda",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "mudar 1 item apenas",
        "func": "var x = msg.payload;\nvar y = global.get(\"Indice_Mongo\");\n\nif (y <= 999){\n    msg.query = { _id: y };\n    msg.payload = {\n        $set: {\"log_mesagens\": x}\n    };\n    y++;\n    global.set(\"Indice_Mongo\",y);\n} else{\n    global.set(\"Indice_Mongo\",1);\n    msg.query = { _id: 1 };\n    msg.payload = {\n        $set: {\"log_mesagens\": x}\n    };\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3010.8333282470703,
        "y": 1179.8247232437134,
        "wires": [
            [
                "3ecc4fdb.5b04a",
                "6ad0c41f.2e1dcc",
                "d2c8d14b.d6c49"
            ]
        ]
    },
    {
        "id": "3ecc4fdb.5b04a",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "4e844c3e.6f0704",
        "name": "update log_erro",
        "collection": "log_erro",
        "payonly": true,
        "upsert": true,
        "multi": true,
        "operation": "update",
        "x": 3294.2777099609375,
        "y": 1179.224612236023,
        "wires": []
    },
    {
        "id": "9df0e9dd.545ba8",
        "type": "mongodb in",
        "z": "a18443b1.146f2",
        "mongodb": "4e844c3e.6f0704",
        "name": "consulta",
        "collection": "indice",
        "operation": "find",
        "x": 3182.6848220825195,
        "y": 1601.22669506073,
        "wires": [
            [
                "21b7197e.f64906"
            ]
        ]
    },
    {
        "id": "21b7197e.f64906",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "indice_mesagens",
        "func": "x =msg.payload[0].indice_mesagens;\nglobal.set(\"Indice_Mongo\",x);\n\nmsg.payload =x;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3368.5711708068848,
        "y": 1600.8749933242798,
        "wires": [
            [
                "a2044bcb.cde0b8"
            ]
        ]
    },
    {
        "id": "fcf29686.2b3c68",
        "type": "link in",
        "z": "a18443b1.146f2",
        "name": "tabs2",
        "links": [
            "5cfe9ef7.3c779"
        ],
        "x": 2514.7060012817383,
        "y": 1647.5791788101196,
        "wires": [
            [
                "2fcd60de.93481"
            ]
        ]
    },
    {
        "id": "5cfe9ef7.3c779",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "",
        "links": [
            "fcf29686.2b3c68"
        ],
        "x": 1774.2712364196777,
        "y": 2786.1166219711304,
        "wires": []
    },
    {
        "id": "11b7e3d8.d55d5c",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Desbobinador",
        "info": "",
        "x": 1881.2712364196777,
        "y": 2727.300093650818,
        "wires": []
    },
    {
        "id": "ce740831.6c9178",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "TABS2",
        "info": "",
        "x": 1861.9713096618652,
        "y": 2785.300093650818,
        "wires": []
    },
    {
        "id": "af83648a.23dff8",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "MbPrsSentido M2.14",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 1856.6046104431152,
        "y": 2590.2001180648804,
        "wires": [
            [
                "419f5d36.434da4"
            ],
            [
                "d870166f.d9d648"
            ]
        ]
    },
    {
        "id": "419f5d36.434da4",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "852160e7.76eea"
        ],
        "x": 2033.6713371276855,
        "y": 2572.1501359939575,
        "wires": []
    },
    {
        "id": "d870166f.d9d648",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2033.361888885498,
        "y": 2606.7692766189575,
        "wires": []
    },
    {
        "id": "6a9aaf3b.ecba7",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "ComandoMaquina0",
        "func": "global.set(\"ComandoMaquina\",0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3318.6061477661133,
        "y": 2563.812424659729,
        "wires": [
            []
        ]
    },
    {
        "id": "df261a74.c0a168",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Delay 50ms",
        "func": "setTimeout(function() {\n node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Reverter prensa\"});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 2588.3822708129883,
        "y": 2576.112482070923,
        "wires": [
            [
                "7d3d1bf2.9ad254"
            ]
        ]
    },
    {
        "id": "7d3d1bf2.9ad254",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Parar motor",
        "func": "//muda 3.3\nvar mensagens = global.get(\"mensagens\");\nvar modbus = global.get(\"ModBus\");\nvar msg2 = {};\n\n// M3.3 igual a 0 Desliga motor\n modbus[2] &= ~(1<<12);\n msg.payload = modbus[2];\n msg2.payload ={ type: 'info', message: 'Desligando motor para reverter...' };\n msg2.payload.time= new Date();\n node.status({fill:\"yellow\",shape:\"ring\",text:\"Deslingado\"});\n\nglobal.set(\"MotorLigado\",0);\nglobal.set('ModBus', modbus);//Atualiza registrador global\nreturn [msg, msg2];",
        "outputs": "2",
        "noerr": 0,
        "x": 2765.3727493286133,
        "y": 2575.812424659729,
        "wires": [
            [
                "eb9cd39d.7875f"
            ],
            [
                "e5967f2a.98f93"
            ]
        ]
    },
    {
        "id": "eb9cd39d.7875f",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Desliga motor M2.12",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 3024.372871398926,
        "y": 2569.812424659729,
        "wires": [
            [
                "6a9aaf3b.ecba7"
            ],
            []
        ]
    },
    {
        "id": "e5967f2a.98f93",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "Topico Estado da Maquina",
        "topic": "AplanadoraN/Estado",
        "qos": "0",
        "retain": "false",
        "broker": "d8f46f1a.2a7e2",
        "x": 3045.372871398926,
        "y": 2619.812424659729,
        "wires": []
    },
    {
        "id": "e831add7.3daed",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Desliga & zerar tudo!",
        "dataType": "HoldingRegister",
        "adr": "2",
        "server": "357d20ae.edfc8",
        "x": 1856.0544128417969,
        "y": 2662.9166922569275,
        "wires": [
            [
                "c209051f.e77d28"
            ],
            [
                "ea8b01d4.c3693"
            ]
        ]
    },
    {
        "id": "ea8b01d4.c3693",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 2032.8342933654785,
        "y": 2680.598086833954,
        "wires": []
    },
    {
        "id": "3ca4577d.719cd8",
        "type": "link in",
        "z": "a18443b1.146f2",
        "name": "",
        "links": [
            "c209051f.e77d28"
        ],
        "x": 1970.735026359558,
        "y": 1559.908465385437,
        "wires": [
            []
        ]
    },
    {
        "id": "c209051f.e77d28",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "reset maquina",
        "links": [
            "3ca4577d.719cd8"
        ],
        "x": 2033.8835678100586,
        "y": 2645.4792761802673,
        "wires": []
    },
    {
        "id": "8e73b212.de599",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Paginação ",
        "func": "msg.limit = 5;\nmsg.skip = 0;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2987.4557571411133,
        "y": 1652.9624795913696,
        "wires": [
            [
                "9df0e9dd.545ba8"
            ]
        ]
    },
    {
        "id": "723bfef6.29b72",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Consulta MongoDB por string",
        "info": "$options => i for case insensitive search\n\nStart with string\n\ndb.collection.find({zip:{'$regex' : '^string', '$options' : 'i'}})\nEnd with string\n\ndb.collection.find({zip:{'$regex' : 'string$', '$options' : 'i'}})\nContains string\n\ndb.collection.find({zip:{'$regex' : 'string', '$options' : 'i'}})\nDoesn't Contains string\n\ndb.collection.find({zip:{'$regex' : '^((?!string).)*$', '$options' : 'i'}})\nKeep this as a bookmark, and a reference for any other alterations you may need. http://www.cheatography.com/davechild/cheat-sheets/regular-expressions/",
        "x": 283.7321243286133,
        "y": 2341.6594457626343,
        "wires": []
    },
    {
        "id": "ecf44223.b4234",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Exemplo de consulta",
        "func": "msg.limit = parseInt(msg.req.query.size) || 10;\nmsg.skip = ((parseInt(msg.req.query.page) || 1) - 1) * (parseInt(msg.req.query.page) || 1);\nmsg.payload = {nome: {'$regex' : msg.payload.nome, '$options' : 'i'}}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 267.74827575683594,
        "y": 2385.3593215942383,
        "wires": [
            []
        ]
    },
    {
        "id": "f66b5ac9.e4c648",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Desliga se ociosa",
        "func": "var modbus = global.get(\"ModBus\");\nvar tempo = global.get(\"tempo\");\n\nif (((modbus[3]) & (1 << 3))){\n var atrazo = new Date().getTime();\n var diff = Math.round((parseInt((atrazo - tempo))/60000));\n \n node.status({fill:\"green\",shape:\"dot\",text:\"Diferença de tempo em min = \"+ diff});\n}else {\n var start = new Date().getTime();\n global.set(\"tempo\",start);\n node.status({fill:\"green\",shape:\"dot\",text:\"Motor Desligado \"});\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2603.6843032836914,
        "y": 1826.060070991516,
        "wires": [
            [
                "e519962f.7b7098"
            ]
        ]
    },
    {
        "id": "fc304fda.e4611",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Comando para ler todo ModBus",
        "links": [
            "852160e7.76eea"
        ],
        "x": 3319.4779739379883,
        "y": 1770.3456888198853,
        "wires": []
    },
    {
        "id": "8c3fed0f.05f9f",
        "type": "link out",
        "z": "a18443b1.146f2",
        "name": "Erro ModBus",
        "links": [
            "d34aa50f.456728"
        ],
        "x": 3319.16854095459,
        "y": 1805.964774131775,
        "wires": []
    },
    {
        "id": "246f1cda.825a94",
        "type": "modbustcp-no-pooling-write",
        "z": "a18443b1.146f2",
        "name": "Desliga Motor Prensa M3.3",
        "dataType": "HoldingRegister",
        "adr": "3",
        "server": "357d20ae.edfc8",
        "x": 3152.4392623901367,
        "y": 1787.20761013031,
        "wires": [
            [
                "fc304fda.e4611"
            ],
            [
                "8c3fed0f.05f9f"
            ]
        ]
    },
    {
        "id": "5198eae.01a9a14",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 4066.7057876586914,
        "y": 1271.6957559585571,
        "wires": []
    },
    {
        "id": "c9764a36.3b8c68",
        "type": "http in",
        "z": "a18443b1.146f2",
        "name": "/api/usuario/login",
        "url": "/api/usuario/login",
        "method": "post",
        "swaggerDoc": "",
        "x": 142.3987922668457,
        "y": 811.6595544815063,
        "wires": [
            [
                "89fe9654.391e08"
            ]
        ]
    },
    {
        "id": "eb783a93.27fd18",
        "type": "http response",
        "z": "a18443b1.146f2",
        "name": "",
        "x": 999.5229911804199,
        "y": 811.0962190628052,
        "wires": []
    },
    {
        "id": "d0d20129.8984b",
        "type": "md5",
        "z": "a18443b1.146f2",
        "name": "",
        "fieldToHash": "payload",
        "fieldTypeToHash": "msg",
        "hashField": "md5",
        "hashFieldType": "msg",
        "x": 541.8271980285645,
        "y": 1540.5166645050049,
        "wires": [
            [
                "d0425a55.8fbfc8"
            ]
        ]
    },
    {
        "id": "d0425a55.8fbfc8",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "md5 resposta",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 698.970085144043,
        "y": 1540.9452362060547,
        "wires": []
    },
    {
        "id": "7d4af4f2.b145ac",
        "type": "mongodb in",
        "z": "a18443b1.146f2",
        "mongodb": "d00f7484.d7f988",
        "name": "consulta",
        "collection": "config",
        "operation": "find",
        "x": 549.7321243286133,
        "y": 298.3262186050415,
        "wires": [
            [
                "4bcc2949.15baa8"
            ]
        ]
    },
    {
        "id": "8874b641.ff5c48",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Carrega parametros",
        "func": "// No parametro projection 1 ou zero significa ler ou inguinorar resultado\n//msg.projection = { _id: 1, codigo: 1, nome: 1, path: 1}\nmsg.limit = 50;\nmsg.skip = 0;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 368.8703918457031,
        "y": 298.1497926712036,
        "wires": [
            [
                "7d4af4f2.b145ac"
            ]
        ]
    },
    {
        "id": "4bcc2949.15baa8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Dados OK",
        "func": "var msg2 = {};\n\nif (msg.payload.length){\n    msg.payload=msg.payload[0];\n    msg2 = null;\n    node.status({fill:\"blue\",shape:\"dot\",text:msg.payload.codigo});\n    \n}else{ // banco vazio\n    msg2.payload = {};\n    msg.payload = {};\n    node.status({fill:\"red\",shape:\"dot\",text:'erro'});\n}\n\nreturn [msg,msg2];\n",
        "outputs": "2",
        "noerr": 0,
        "x": 706.7321243286133,
        "y": 298.3262186050415,
        "wires": [
            [
                "3ddab26e.4527ee",
                "4ad38845.46cad8"
            ],
            [
                "4a0bde9e.f9d43",
                "8265bf78.56934",
                "93e3b589.fc4b18"
            ]
        ]
    },
    {
        "id": "433382fb.89babc",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "salvar config selecionada",
        "collection": "config",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "store",
        "x": 948.7321243286133,
        "y": 530.3262186050415,
        "wires": []
    },
    {
        "id": "4a0bde9e.f9d43",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Erro --> Abre conexão",
        "func": "let mssql = global.get('mssql');\n\nmsg.payload = \"conectando\";\n\nlet PRODUCAO = new mssql.Connection(\"mssql://financeiro:financeiro@192.168.0.1/FINANCEIRO\", function(err) {\n    if (err) {\n        global.set('conectadoServidor', 0);\n        PRODUCAO.on('error', function(err) {\n            node.error({payload: err || { erro: 9996, mensagem: 'Erro desconhecido na conexão'}});\n        });\n    } else {\n        global.set('conectadoServidor', 1);\n    }\n});\nnode.status({fill:\"yellow\",shape:\"dot\",text:'Conectando 192.168.0.1'});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 936.7321243286133,
        "y": 305.3262186050415,
        "wires": [
            [
                "e21a3edd.5e285"
            ]
        ]
    },
    {
        "id": "a7aac2d7.d6efd",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "CARREGA CONFIG LOCAL",
        "info": "",
        "x": 175.73212432861328,
        "y": 250.3262186050415,
        "wires": []
    },
    {
        "id": "b27f66bb.bbd6e8",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "SALVA CONFIG ESCOLHIDO \"localhost\"",
        "info": "",
        "x": 211.73212432861328,
        "y": 538.3262186050415,
        "wires": []
    },
    {
        "id": "820294f9.f06578",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Verifica a senha e usuario",
        "info": "#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ",
        "x": 171.39878845214844,
        "y": 688.6595458984375,
        "wires": []
    },
    {
        "id": "c1ae7bef.98fe98",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Converte SQL to Mongo",
        "func": "let msg2 ={ payload: msg.payload.usuarios}; //Passa para msg2 o JSON de usuarios\nlet d = new Date(),\n    lodash = global.get('lodash'), \n    i=0;\n\n// Converte iso date para hora local\n//let myDate = new Date().toTimeString().replace(/.*(\\d{2}:\\d{2}:\\d{2}).*/, \"$1\");\n//var x = (\"00\" + (d.getMonth() + 1)).slice(-2) + \"/\" + \n//        (\"00\" + d.getDate()).slice(-2) + \"/\" + \n//        d.getFullYear() + \" \" + myDate;\n\nconst l = (msg2.payload.length||0); //mede o tamanho do array fora do laço\nconst t = d.toISOString();\n\n\n//MAQUINA\nmsg.payload.maquina._id = msg.payload.maquina.id.toString(); //Converte id p/ _id para gravar no mongoDB\nmsg.payload.maquina.atualizacao = t; // Hora da gravação da configuração da maquina\nmsg.payload = lodash.omit(msg.payload.maquina, 'id'); //apaga o original\n\n\n//USUARIO\nfor (i=0; i<l; i++){\n    msg2.payload[i]._id = msg2.payload[i].id.toString();\n    msg2.payload[i].atualizacao = t; // Hora da gravação do log de usuarios\n    msg2.payload[i] = lodash.omit(msg2.payload[i], 'id');\n}\n\n//console.log(JSON.stringify(msg2.payload,null,2));      //Imprime no console o JSON do config que sera gravado\n\nreturn [msg, msg2];\n\n\n \n",
        "outputs": "2",
        "noerr": 0,
        "x": 639.7321243286133,
        "y": 585.3262186050415,
        "wires": [
            [
                "433382fb.89babc",
                "f0ef29bc.b00018",
                "f7581a04.c29f38"
            ],
            [
                "36f538f4.c4c8f8",
                "7c81b676.58ff18"
            ]
        ]
    },
    {
        "id": "2d45f3e2.05adfc",
        "type": "comment",
        "z": "a18443b1.146f2",
        "name": "Parametros de todas as maquinas \"referencia\"",
        "info": "Copia local de segurança de todos os parametros das maquinas\n\nPor default esta carregando essa lista do servidor\n\nÉ possível mudar para carregar local alterando o arquivo \n\n> ihm/src/api/maquina/config/index.js<",
        "x": 274.20825958251953,
        "y": 2138.0880041122437,
        "wires": []
    },
    {
        "id": "3252683a.dafc58",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "50c62a1f.9f8e34",
        "name": "APAGAR TODA A COLLECTION operadores",
        "collection": "operadores",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "delete",
        "x": 582.8042602539062,
        "y": 1857.60693359375,
        "wires": []
    },
    {
        "id": "8fccc1a0.62666",
        "type": "mongodb out",
        "z": "a18443b1.146f2",
        "mongodb": "48e8ca15.b87cb4",
        "name": "salvar tabela usuarios",
        "collection": "operadores",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "store",
        "x": 1102.681432723999,
        "y": 673.0502548217773,
        "wires": []
    },
    {
        "id": "89fe9654.391e08",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "Carrega operador",
        "func": "// No parametro projection 1 ou zero significa ler ou inguinorar resultado\nlet parametro = msg.payload;\n\nmsg.payload = {usuario:{$in:[parametro.usuario]}, senha:{$in:[parametro.senha]}};\n//msg.projection = { usuario: 1, senha: 1};\nmsg.limit = 5;\nmsg.skip = 0;\n\nnode.status({fill:\"yellow\",shape:\"dot\",text: parametro.usuario + ' ' + parametro.senha});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 391.89531326293945,
        "y": 811.2954034805298,
        "wires": [
            [
                "4900b49a.7bb33c"
            ]
        ]
    },
    {
        "id": "4900b49a.7bb33c",
        "type": "mongodb in",
        "z": "a18443b1.146f2",
        "mongodb": "d00f7484.d7f988",
        "name": "consulta operadores",
        "collection": "operadores",
        "operation": "find",
        "x": 647.328369140625,
        "y": 811.4717931747437,
        "wires": [
            [
                "e35d05d5.e89e98"
            ]
        ]
    },
    {
        "id": "cbf09f25.e113a",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "operadores",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1016.8902282714844,
        "y": 767.3934926986694,
        "wires": []
    },
    {
        "id": "81d5a40a.670e48",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "Usuario conhecido",
        "topic": "",
        "payload": "{ \"usuario\": \"helio\", \"senha\": \"helio2\" }",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 152.58355712890625,
        "y": 770.6712036132812,
        "wires": [
            [
                "89fe9654.391e08"
            ]
        ]
    },
    {
        "id": "7c81b676.58ff18",
        "type": "split",
        "z": "a18443b1.146f2",
        "name": "",
        "splt": "\\n",
        "x": 889.7524337768555,
        "y": 672.8537282943726,
        "wires": [
            [
                "8fccc1a0.62666"
            ]
        ]
    },
    {
        "id": "e35d05d5.e89e98",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "senha",
        "func": "msg.payload = msg.payload[0]?msg.payload[0]:{};\n\nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 829.1810493469238,
        "y": 811.3731164932251,
        "wires": [
            [
                "cbf09f25.e113a",
                "eb783a93.27fd18"
            ]
        ]
    },
    {
        "id": "8e9fca31.542538",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "Usuario desconhecido",
        "topic": "",
        "payload": "{ \"usuario\": \"helio2\", \"senha\": \"456\" }",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 161.746337890625,
        "y": 729.8773803710938,
        "wires": [
            [
                "89fe9654.391e08"
            ]
        ]
    },
    {
        "id": "36f538f4.c4c8f8",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "usuarios",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 899.4281692504883,
        "y": 626.5705680847168,
        "wires": []
    },
    {
        "id": "e165b479.241438",
        "type": "mqtt in",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "fabrica/ihm/erros/#",
        "qos": "0",
        "broker": "d8f46f1a.2a7e2",
        "x": 155.42811584472656,
        "y": 958.2495126724243,
        "wires": [
            [
                "73c83e6a.34ddf"
            ]
        ]
    },
    {
        "id": "73c83e6a.34ddf",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 512.367431640625,
        "y": 958.4052829742432,
        "wires": []
    },
    {
        "id": "df740966.fddbc8",
        "type": "mqtt in",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "fabrica/ihm/debug/#",
        "qos": "0",
        "broker": "d8f46f1a.2a7e2",
        "x": 150.88917541503906,
        "y": 1018.8773918151855,
        "wires": [
            [
                "2c084385.d58f3c"
            ]
        ]
    },
    {
        "id": "2c084385.d58f3c",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 510.6856384277344,
        "y": 1019.0331439971924,
        "wires": []
    },
    {
        "id": "72e60741.464c48",
        "type": "mqtt in",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "fabrica/ihm/estado/#",
        "qos": "0",
        "broker": "d8f46f1a.2a7e2",
        "x": 156.74632263183594,
        "y": 1072.8773736953735,
        "wires": [
            [
                "56638c9.0985774"
            ]
        ]
    },
    {
        "id": "56638c9.0985774",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 513.6856384277344,
        "y": 1073.0331439971924,
        "wires": []
    },
    {
        "id": "3be3f26.d24bc0e",
        "type": "mqtt in",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "fabrica/ihm/comandos/#",
        "qos": "0",
        "broker": "d8f46f1a.2a7e2",
        "x": 166.74632263183594,
        "y": 1125.8773736953735,
        "wires": [
            [
                "dbf83e5d.f5654"
            ]
        ]
    },
    {
        "id": "dbf83e5d.f5654",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 513.6856384277344,
        "y": 1126.0331439971924,
        "wires": []
    },
    {
        "id": "44482bdc.d8aad4",
        "type": "mqtt in",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "fabrica/ihm/timer/",
        "qos": "0",
        "broker": "d8f46f1a.2a7e2",
        "x": 146.74632263183594,
        "y": 1188.4227838516235,
        "wires": [
            [
                "f18ae9ef.054448"
            ]
        ]
    },
    {
        "id": "f18ae9ef.054448",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 513.6856384277344,
        "y": 1188.5785541534424,
        "wires": []
    },
    {
        "id": "e1f419d3.4ef328",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "fabrica/ihm/debug/REFORCO",
        "topic": "fabrica/ihm/debug/REFORCO",
        "qos": "0",
        "retain": "",
        "broker": "d8f46f1a.2a7e2",
        "x": 1003.4252853393555,
        "y": 952.6358270645142,
        "wires": []
    },
    {
        "id": "130b8037.f285c",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "",
        "payload": "{'O que você quer fazer ?'}",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 768.4309463500977,
        "y": 952.8517436981201,
        "wires": [
            [
                "e1f419d3.4ef328"
            ]
        ]
    },
    {
        "id": "2309c7df.3d81d8",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "fabrica/ihm/debug/PERF-N3",
        "topic": "fabrica/ihm/debug/PERF-N3",
        "qos": "0",
        "retain": "",
        "broker": "d8f46f1a.2a7e2",
        "x": 1003.7463455200195,
        "y": 1068.4228372573853,
        "wires": []
    },
    {
        "id": "d39cde7a.260ea",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "",
        "payload": "{'O que você quer fazer ?'}",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 768.7520065307617,
        "y": 1068.6387538909912,
        "wires": [
            [
                "2309c7df.3d81d8"
            ]
        ]
    },
    {
        "id": "5d71ef6c.b236e",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "fabrica/ihm/estado/REFORCO",
        "topic": "fabrica/ihm/estado/REFORCO",
        "qos": "0",
        "retain": "",
        "broker": "d8f46f1a.2a7e2",
        "x": 1027.7605667114258,
        "y": 1181.4285135269165,
        "wires": []
    },
    {
        "id": "e4694fe.b29d6b",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "",
        "payload": "{'O que você quer fazer ?'}",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 782.766227722168,
        "y": 1181.6444301605225,
        "wires": [
            [
                "5d71ef6c.b236e"
            ]
        ]
    },
    {
        "id": "2d3bd6e4.a0ae1a",
        "type": "mqtt in",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "fabrica/ihm/user/#",
        "qos": "0",
        "broker": "d8f46f1a.2a7e2",
        "x": 144.74633026123047,
        "y": 1247.2410135269165,
        "wires": [
            [
                "92430e75.6ed3f"
            ]
        ]
    },
    {
        "id": "92430e75.6ed3f",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 511.6856460571289,
        "y": 1247.3967838287354,
        "wires": []
    },
    {
        "id": "13207f00.9451c1",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 1140.42529296875,
        "y": 206.48812866210938,
        "wires": [
            [
                "52df09cc.7ff8e8"
            ]
        ]
    },
    {
        "id": "ddd7db9a.e50be8",
        "type": "function",
        "z": "a18443b1.146f2",
        "name": "timer",
        "func": "let myHours = new Date().toTimeString().replace(/.*(\\d{2}:\\d{2}:\\d{2}).*/, \"$1\");\n\nlet d = new Date();\nlet x = (\"00\" + (d.getMonth() + 1)).slice(-2) + \"/\" + \n        (\"00\" + d.getDate()).slice(-2) + \"/\" + \n        d.getFullYear() + \" \" + myHours.slice(0,5);\n        \nlet y = (\"00\" + (d.getMonth() + 1)).slice(-2) + \"/\" + \n        (\"00\" + d.getDate()).slice(-2) + \"/\" + \n        d.getFullYear();\n\nmsg.payload = \n  {\n    \"date\": y,\n    \"hours\": myHours.slice(0,5)\n  };\n  \nnode.status({fill:\"blue\",shape:\"dot\",text:x});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 396.74634552001953,
        "y": 1672.2410135269165,
        "wires": [
            [
                "5a315989.3b2978",
                "e7f24b05.8187b8"
            ]
        ]
    },
    {
        "id": "f6c3fc59.d9798",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "timer",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "60",
        "crontab": "",
        "once": false,
        "x": 185.42811584472656,
        "y": 1671.204005241394,
        "wires": [
            [
                "ddd7db9a.e50be8"
            ]
        ]
    },
    {
        "id": "5a315989.3b2978",
        "type": "debug",
        "z": "a18443b1.146f2",
        "name": "timer",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 560.4224319458008,
        "y": 1671.0278844833374,
        "wires": []
    },
    {
        "id": "e7f24b05.8187b8",
        "type": "mqtt out",
        "z": "a18443b1.146f2",
        "name": "timer",
        "topic": "fabrica/ihm/timer/",
        "qos": "0",
        "retain": "",
        "broker": "d8f46f1a.2a7e2",
        "x": 564.4338302612305,
        "y": 1622.7210626602173,
        "wires": []
    },
    {
        "id": "c5c14173.7c3e7",
        "type": "e-mail",
        "z": "a18443b1.146f2",
        "server": "smtp.gmail.com",
        "port": "587",
        "secure": false,
        "name": "ihmaltamira@gmail.com",
        "dname": "",
        "x": 861,
        "y": 3042,
        "wires": []
    },
    {
        "id": "3323d041.2eee8",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "IHM-ALIMENTADOR-N3",
        "payload": "teste de mensagem",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 318,
        "y": 3190,
        "wires": [
            [
                "d2ddc1fc.a4e83"
            ]
        ]
    },
    {
        "id": "3b07a96b.6d61c6",
        "type": "inject",
        "z": "a18443b1.146f2",
        "name": "",
        "topic": "IHM-ALIMENTADOR-N3",
        "payload": "teste de mensagem",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 317,
        "y": 3128,
        "wires": [
            [
                "9a2f8b50.60d5d8"
            ]
        ]
    },
    {
        "id": "50c62a1f.9f8e34",
        "type": "mongodb",
        "z": "a18443b1.146f2",
        "hostname": "127.0.0.1",
        "port": "27017",
        "db": "db",
        "name": ""
    },
    {
        "id": "d8f46f1a.2a7e2",
        "type": "mqtt-broker",
        "z": "",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": true,
        "keepalive": "60",
        "cleansession": true,
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": ""
    },
    {
        "id": "357d20ae.edfc8",
        "type": "modbustcp-no-pooling-server",
        "z": "",
        "host": "127.0.0.1",
        "port": "502",
        "unit_id": "1"
    },
    {
        "id": "4e844c3e.6f0704",
        "type": "mongodb",
        "z": "a18443b1.146f2",
        "hostname": "127.0.0.1",
        "port": "27017",
        "db": "db",
        "name": ""
    },
    {
        "id": "d00f7484.d7f988",
        "type": "mongodb",
        "z": "",
        "hostname": "127.0.0.1",
        "port": "27017",
        "db": "db",
        "name": ""
    },
    {
        "id": "48e8ca15.b87cb4",
        "type": "mongodb",
        "z": "",
        "hostname": "127.0.0.1",
        "port": "27017",
        "db": "db",
        "name": ""
    }
]