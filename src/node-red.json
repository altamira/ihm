[{"id":"dd7c3d4d.544e1","type":"inject","z":"6e1cdd6e.93025c","name":"connect","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":140,"y":100,"wires":[["b53e3116.967c1"]]},{"id":"b53e3116.967c1","type":"function","z":"6e1cdd6e.93025c","name":"PRODUCAO","func":"var mssql = global.get('mssql');\n\nvar PRODUCAO = new mssql.Connection(\"mssql://financeiro:financeiro@192.168.0.1/FINANCEIRO\", function(err) {\n    if (err) {\n        console.dir('-------------> ERRO NA CONEXAO PRODUCAO !!!!!! <-------------')\n    } else {\n        global.set('PRODUCAO', PRODUCAO);\n        console.dir('CONECTADO PRODUCAO !')\n        \n        PRODUCAO.on('error', function(err) {\n            node.error({payload: err || { erro: 9996, mensagem: 'Erro desconhecido na conexÃ£o'}})\n        });\n        \n    }\n});\n","outputs":1,"noerr":0,"x":370,"y":100,"wires":[["a0e0a2b1.523d3"]]},{"id":"a0e0a2b1.523d3","type":"debug","z":"6e1cdd6e.93025c","name":"result","active":true,"console":"false","complete":"payload","x":610,"y":100,"wires":[]},{"id":"e795e417.f370f8","type":"http in","z":"6e1cdd6e.93025c","name":"maquinas listar","url":"/api/maquina/","method":"get","swaggerDoc":"","x":131.99999237060547,"y":211.99998950958252,"wires":[["dabd7ec1.8f9dc"]]},{"id":"e2035132.003f5","type":"http response","z":"6e1cdd6e.93025c","name":"","x":608.9999561309814,"y":211.9999885559082,"wires":[]},{"id":"dabd7ec1.8f9dc","type":"function","z":"6e1cdd6e.93025c","name":"Parametro Iniciais","func":"var myDate = new Date().toTimeString().replace(/.*(\\d{2}:\\d{2}:\\d{2}).*/, \"$1\");\n\nvar d = new Date();\nvar x = (\"00\" + (d.getMonth() + 1)).slice(-2) + \"/\" + \n        (\"00\" + d.getDate()).slice(-2) + \"/\" + \n        d.getFullYear() + \" \" + myDate;\n\nmsg.payload = \n[\n  {\n    \"_id\": \"Aplanadora-N3\",\n    \"codigo\": \"PERF-N3\",\n    \"nome\": \"Aplanadora N3\",\n    \"path\": \"maquinas/perfiladeiras/n3\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.230\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.231\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.232\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n    \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9978,\n        \"resolucao\": 2500,\n        \"perimetro\": 400\n      },\n      \"manual\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 95,\n        \"paradaEntrePecasProduzidas\": 0,\n        \"tempoParada\": 0\n      },\n      \"transmissao\": {\n        \"reducao\": 0,\n        \"diametrorolo\": 0,\n        \"avancoMilimetrosPorRotacao\": 9.5144\n      },\n      \"corte\":{\n        \"espessura\": 0,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"passoN2\": 200,\n        \"passoN3\": 200,\n        \"passoN5\": 200\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"10095646\",\n        \"produto\": {\n          \"codigo\": \"ESTCAN000N300000000#2000#0#0\",\n          \"descricao\": \"CANTONEIRA N-3 2000MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"produzindo\"\n      },\n      {\n        \"numero\": \"10095645\",\n        \"produto\": {\n          \"codigo\": \"ESTCAN000N300000000#2400#0#0\",\n          \"descricao\": \"CANTONEIRA N-3 2400MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"pendente\"\n      }\n    ]\n  },\n  {\n    \"_id\": \"Perfiladeira Reforco\",\n    \"codigo\": \"REFORCO\",\n    \"nome\": \"Perfiladeira Reforco\",\n    \"path\": \"maquinas/perfiladeiras/reforco\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.233\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.234\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.235\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n     \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9986,\n        \"resolucao\": 2500,\n        \"perimetro\": 127.32\n      },\n      \"manual\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"0.6\",\n        \"desaceleracao\": \"0.6\",\n        \"velocidade\": 95,\n        \"paradaEntrePecasProduzidas\": 20,\n        \"tempoParada\": 10\n      },\n      \"transmissao\": {\n        \"reducao\": 0,\n        \"diametrorolo\": 0,\n        \"avancoMilimetrosPorRotacao\": 9.5144\n      },\n      \"corte\":{\n        \"espessura\": 5,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"corte\": 1,\n        \"furo\": 20\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"1231-11\",\n        \"produto\": {\n          \"codigo\": \"PPLESTREFOUGAL000000#0#0#610\",\n          \"descricao\": \"PERFIL U GALV P/ APOIO DE CAIXA MED 610MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-11T11:22:08.224Z\",\n        \"status\": \"produzindo\"\n      },\n      {\n        \"numero\": \"8792-55\",\n        \"produto\": {\n          \"codigo\": \"PPLESTREFOUGAL000000#0#0#910\",\n          \"descricao\": \"PERFIL U GALV P/ APOIO DE CAIXA MED 910MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"pendente\"\n      }\n    ]\n  },\n    {\n    \"_id\": \"Perfiladeira Sigma 120\",\n    \"codigo\": \"Sigma 120\",\n    \"nome\": \"Perfiladeira Sigma 120\",\n    \"path\": \"maquinas/perfiladeiras/sigma120\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.236\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.237\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.238\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n     \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9909,\n        \"resolucao\": 2500,\n        \"perimetro\": 400\n      },\n      \"manual\": {\n        \"aceleracao\": \"3\",\n        \"desaceleracao\": \"1\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"2\",\n        \"desaceleracao\": \"1\",\n        \"velocidade\": 100,\n        \"paradaEntrePecasProduzidas\": 40,\n        \"tempoParada\": 2\n      },\n      \"transmissao\": {\n        \"reducao\": \"72.73\",\n        \"diametrorolo\": 165,\n        \"avancoMilimetrosPorRotacao\": 0\n      },\n      \"corte\":{\n        \"espessura\": 5,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"corte\": 1\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"1231-11\",\n        \"produto\": {\n          \"codigo\": \"MEZSIG0CH1412000000#1800#0#0\",\n          \"descricao\": \"VIGA SIGMA 120 CH 2.00 MM MED 1800MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2017-04-10T11:22:08.224Z\",\n        \"status\": \"Produzindo\"\n      },\n      {\n        \"numero\": \"8792-55\",\n        \"produto\": {\n          \"codigo\": \"PPLSTRSI120050D00000#1200#0#0\",\n          \"descricao\": \"STOP TRAZEIRO SIGMA 120 DEITADO MED 1200MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2017-04-14T11:22:08.224Z\",\n        \"status\": \"Pendente\"\n      }\n    ]\n  }\n]\nnode.status({fill:\"blue\",shape:\"dot\",text:x});\nreturn msg;","outputs":1,"noerr":0,"x":378.00001525878906,"y":212.99999809265137,"wires":[["e2035132.003f5"]]},{"id":"1ea0925b.801eee","type":"http in","z":"6e1cdd6e.93025c","name":"maquinas alterar","url":"/api/maquina/","method":"put","swaggerDoc":"","x":140,"y":300,"wires":[["66f66c9a.bdb4a4"]]},{"id":"599d869d.a3fab8","type":"http response","z":"6e1cdd6e.93025c","name":"","x":610,"y":300,"wires":[]},{"id":"69f4cdf4.ed9f74","type":"function","z":"6e1cdd6e.93025c","name":"SQL","func":"return msg;","outputs":1,"noerr":0,"x":390,"y":300,"wires":[["599d869d.a3fab8"]]},{"id":"12239c2f.f66a04","type":"http in","z":"6e1cdd6e.93025c","name":"maquinas incluir","url":"/api/maquina/","method":"post","swaggerDoc":"","x":140,"y":260,"wires":[["66f66c9a.bdb4a4"]]},{"id":"911313cd.172d8","type":"http response","z":"6e1cdd6e.93025c","name":"","x":610,"y":260,"wires":[]},{"id":"8bbe839e.6137","type":"function","z":"6e1cdd6e.93025c","name":"SQL","func":"return msg;","outputs":1,"noerr":0,"x":390,"y":260,"wires":[["911313cd.172d8"]]},{"id":"fa9e33fe.a503a","type":"function","z":"6e1cdd6e.93025c","name":"Lista de maquinas","func":"msg.payload = \n{\n\"_id\": \"Maquinas\",\n    \"Aplanadora-N3\": {\n      \"IP-IHM\" : \"192.168.2.230\",\n      \"IP-POP7\": \"192.168.2.235\",\n      \"IP-ESP8266\" : \"\",\n      \"Atualizacao\" : \"2017-03-09T11:44:56.224Z\",\n      \"parametros\": {\n          \"encoder\": {\n              \"fator\": 9998,\n              \"resolucao\": 2500,\n              \"perimetro\": 400\n          },\n          \"velocidade\": {\n              \"automatico\": 100,\n              \"manual\": 30\n          },\n          \"ferramenta\": {\n              \"passo\": 200\n          },\n          \"lubrificacao\": {\n              \"preset\": {\n                  \"MbNovoCiclos\": 100000\n              },\n              \"ciclos\": {\n                  \"PrsCiclos\": 5000\n              }\n          }\n      },\n      \"estado\": {\n          \"situacao\": {\n              \"codigo\": 4,\n              \"descricao\": \"Maquina OK\"\n          }\n      },\n      \"operadores\": {\n          \"IRANILDO\": {\n            \"md5\": \"93d8659ef7a80a65d1434366d96c8e13\"\n          },\n          \"MARCELO\": {\n            \"md5\": \"995bf053c4694e1e353cfd42b94e4447\"\n          }\n      },\n      \"os\": {\n          \"1231-11\": {\n            \"produto\": {\n                \"codigo\": \"XXXXXXXXX\",\n                \"descricao\": \"AAAAAABBBBBCCCCC\",\n                \"quantidade\": 1550,\n                \"produzido\": 299,\n                \"refugo\": 2\n            },\n            \"status\": \"produzindo\"\n          },\n          \"8792-55\": {\n            \"produto\": {\n                \"codigo\": \"XXXXXXXXX\",\n                \"descricao\": \"AAAAAABBBBBCCCCC\",\n                \"quantidade\": 700,\n                \"produzido\": 10,\n                \"refugo\": 10\n            },\n            \"status\": \"pendente\"\n          }\n      }\n    },\n    \"Perfiladeira-ReforÃ§o\": {\n      \"IP-IHM\" : \"192.168.2.220\",\n      \"IP-POP7\": \"192.168.2.211\",\n      \"IP-ESP8266\" : \"\",\n      \"Atualizacao\" : \"2015-02-10T11:22:08.224Z\",\n      \"parametros\": {\n          \"encoder\": {\n              \"fator\": 9998,\n              \"resolucao\": 2500,\n              \"perimetro\": 400\n          },\n          \"velocidade\": {\n              \"automatico\": 100,\n              \"manual\": 30\n          },\n          \"ferramenta\": {\n              \"passo\": 200\n          },\n          \"lubrificacao\": {\n              \"preset\": {\n                  \"MbNovoCiclos\": 100000\n              },\n              \"ciclos\": {\n                  \"PrsCiclos\": 5000\n              }\n          }\n      },\n      \"estado\": {\n          \"situacao\": {\n              \"codigo\": 1,\n              \"descricao\": \"Desligada\"\n          }\n      },\n      \"operadores\": {\n          \"IRANILDO\": {\n            \"md5\": \"93d8659ef7a80a65d1434366d96c8e13\"\n          },\n          \"MARCELO\": {\n            \"md5\": \"995bf053c4694e1e353cfd42b94e4447\"\n          }\n      },\n      \"os\": {\n          \"9999-44\": {\n            \"produto\": {\n                \"codigo\": \"QQQQQQQQQQQQ\",\n                \"descricao\": \"KKKKKKKBBBBBCCCCC\",\n                \"quantidade\": 350,\n                \"produzido\": 350,\n                \"refugo\": 0\n            },\n            \"status\": \"finalizado\"\n          },\n          \"6662-00\": {\n            \"produto\": {\n                \"codigo\": \"YYYYYYY\",\n                \"descricao\": \"GGGGGGBBBBBCCCCC\",\n                \"quantidade\": 150,\n                \"produzido\": 155,\n                \"refugo\": 5\n            },\n            \"status\": \"finalizado\"\n          }\n      }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":460,"wires":[["52fe9e32.0fac2"]]},{"id":"52fe9e32.0fac2","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"false","x":625.5,"y":461,"wires":[]},{"id":"a4a5db9d.648798","type":"inject","z":"6e1cdd6e.93025c","name":"mostrar JSON","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":147.5,"y":461.00000762939453,"wires":[["fa9e33fe.a503a"]]},{"id":"6ce018bc.1db698","type":"http in","z":"6e1cdd6e.93025c","name":"login","url":"/api/usuario/login","method":"post","swaggerDoc":"","x":870,"y":460,"wires":[["c50601c1.718e2","8ae53ca1.a31e7"]]},{"id":"17fb7726.cd2f69","type":"http response","z":"6e1cdd6e.93025c","name":"","x":1348,"y":460,"wires":[]},{"id":"904305d0.e512c8","type":"http in","z":"6e1cdd6e.93025c","name":"config","url":"/api/maquina/config","method":"get","swaggerDoc":"","x":130,"y":580,"wires":[["8e1e1701.47ab68","8d2e240f.e24ab8"]]},{"id":"8d2e240f.e24ab8","type":"function","z":"6e1cdd6e.93025c","name":"json","func":"msg.payload = {\n    id: 123,\n    codigo: 'PERF-N3',\n    nome: 'Cantoneira N3',\n    path: 'maquinas/perfiladeiras/n3'\n}\n\n// comentar essa linha\nmsg.payload = null;\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":580,"wires":[["ae997d5f.cdebc","964f64ff.539ef8"]]},{"id":"ae997d5f.cdebc","type":"http response","z":"6e1cdd6e.93025c","name":"","x":530,"y":580,"wires":[]},{"id":"c50601c1.718e2","type":"debug","z":"6e1cdd6e.93025c","name":"disparo ","active":true,"console":"false","complete":"payload","x":1057.5,"y":510,"wires":[]},{"id":"7b10a930.c678c8","type":"debug","z":"6e1cdd6e.93025c","name":"resposta SQL","active":true,"console":"false","complete":"payload","x":1357,"y":508,"wires":[]},{"id":"8ae53ca1.a31e7","type":"function","z":"6e1cdd6e.93025c","name":"senha","func":"\nvar msg2 = {};\nmsg2.payload = msg.payload.senha;\n\nmsg.payload = {\n    id: 123,\n    usuario: 'rita',\n    senha: '2794d223f90059c9f705c73a99384085',\n    nome: 'rita'\n};\n\nreturn [msg,msg2];","outputs":"2","noerr":0,"x":1126,"y":464,"wires":[["17fb7726.cd2f69","7b10a930.c678c8"],[]]},{"id":"964f64ff.539ef8","type":"debug","z":"6e1cdd6e.93025c","name":"resposta mongo config","active":true,"console":"false","complete":"payload","x":590,"y":540,"wires":[]},{"id":"8e1e1701.47ab68","type":"debug","z":"6e1cdd6e.93025c","name":"IHM pedindo config","active":true,"console":"false","complete":"payload","x":339,"y":512.9999752044678,"wires":[]},{"id":"bf4d7693.b5a9e8","type":"comment","z":"6e1cdd6e.93025c","name":"Node-red Local","info":"","x":1140,"y":420,"wires":[]},{"id":"66f66c9a.bdb4a4","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"payload","x":418.99998474121094,"y":351.99999237060547,"wires":[]},{"id":"a0d97272.d60cd","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":160,"wires":[["dabd7ec1.8f9dc"]]},{"id":"ff875db0.15f9d","type":"comment","z":"6e1cdd6e.93025c","name":"API DO SERVIDOR - 192.168.0.1","info":"","x":200,"y":40,"wires":[]},{"id":"3e68b06c.f32af","type":"comment","z":"6e1cdd6e.93025c","name":"API DA IHM - 127.0.0.1/localhost","info":"","x":190,"y":400,"wires":[]},{"id":"9df23dbb.d454e","type":"http in","z":"6e1cdd6e.93025c","name":"config","url":"/api/maquina/config","method":"post","swaggerDoc":"","x":130,"y":640,"wires":[["e398e361.438b68"]]},{"id":"e398e361.438b68","type":"http response","z":"6e1cdd6e.93025c","name":"","x":530,"y":640,"wires":[]},{"id":"f40eac61.74178","type":"md5","z":"6e1cdd6e.93025c","name":"","fieldToHash":"payload","fieldTypeToHash":"msg","hashField":"md5","hashFieldType":"msg","x":960,"y":200,"wires":[["ca3721f6.51b8"]]},{"id":"fe3d4e02.6aec5","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"HELIO","payloadType":"str","repeat":"","crontab":"","once":false,"x":810,"y":200,"wires":[["f40eac61.74178"]]},{"id":"ca3721f6.51b8","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"true","x":1110,"y":200,"wires":[]},{"id":"8f7c090b.4c6718","type":"e-mail","z":"6e1cdd6e.93025c","server":"smtp.gmail.com","port":"465","name":"","dname":"","x":761,"y":827,"wires":[]},{"id":"a661bee8.f94f","type":"function","z":"6e1cdd6e.93025c","name":"","func":"msg.from = \"pxa255@gmail.com\";\nmsg.to = \"marcelo.miranda@tecnequip.com.br\";\nmsg.cc = \"pxa255@gmail.com\";\nmsg.payload  = \"Testando 4 o envio de emails pelo node-red\";\nreturn msg;","outputs":1,"noerr":0,"x":577,"y":829,"wires":[["8f7c090b.4c6718","98451890.645b28"]]},{"id":"98451890.645b28","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"true","x":757,"y":892,"wires":[]},{"id":"4cc76b95.e73bc4","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":401,"y":828,"wires":[["a661bee8.f94f"]]},{"id":"1e8ce248.23647e","type":"e-mail in","z":"6e1cdd6e.93025c","name":"","protocol":"IMAP","server":"imap.gmail.com","useSSL":true,"port":"993","box":"INBOX","disposition":"Read","repeat":"30","x":347.86363220214844,"y":1092.9402680397034,"wires":[["ead55fbc.95d6d"]]},{"id":"ead55fbc.95d6d","type":"debug","z":"6e1cdd6e.93025c","name":"recebidos","active":true,"console":"false","complete":"true","x":552.860668182373,"y":1036.525384902954,"wires":[]},{"id":"91b8a711.fa64c8","type":"mqtt in","z":"6e1cdd6e.93025c","name":"enviar email","topic":"+/task/completed/sendTask/Task_1d9liyj/#","qos":"2","broker":"22f8853c.a833ca","x":308.0994567871094,"y":1257.6363525390625,"wires":[["7aa239d5.ffa998"]]},{"id":"7aa239d5.ffa998","type":"function","z":"6e1cdd6e.93025c","name":"parse","func":"try {\n    let payload = JSON.parse(msg.payload);\n    payload.document = JSON.parse(payload.document);\n    msg.payload = payload;\n    msg.from = 'orcamento@altamira.com.br'\n    msg.to = 'alessandro@altamira.com.br' //msg.payload.document.representante.email\n    msg.topic = 'Recado: ' + msg.payload.document.empresa;\n    node.status({ fill:\"green\", shape:\"dot\", text: msg.topic });\n}\ncatch(e) {\n    console.log('Parse error: ' + e)\n    node.error('Parse error: ' + e)\n    node.status({ fill:\"red\", shape:\"dot\", text: e.message });\n}\n\nreturn msg;","outputs":"1","noerr":0,"x":488.0994567871094,"y":1257.6363525390625,"wires":[["3af0e500.be9bcc","40b3f82.02de208"]]},{"id":"7fa242c1.979a0c","type":"debug","z":"6e1cdd6e.93025c","name":"EMAIL RECADO","active":true,"console":"false","complete":"true","x":968.0994567871094,"y":1257.6363525390625,"wires":[]},{"id":"3d1a8181.4baabe","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":678.0994567871094,"y":1217.6363525390625,"wires":[["b8103a11.b343d8"]]},{"id":"3af0e500.be9bcc","type":"debug","z":"6e1cdd6e.93025c","name":"EMAIL RECADO","active":true,"console":"false","complete":"true","x":698.0994873046875,"y":1169.6363582611084,"wires":[]},{"id":"fbf811fa.f8082","type":"mqtt in","z":"6e1cdd6e.93025c","name":"gravar recado","topic":"+/task/completed/userTask/Task_1mfcqmp/#","qos":"2","broker":"22f8853c.a833ca","x":308.0994567871094,"y":1417.6363525390625,"wires":[["ed460395.4dc7e"]]},{"id":"ed460395.4dc7e","type":"function","z":"6e1cdd6e.93025c","name":"parse","func":"try {\n    let payload = JSON.parse(msg.payload);\n    payload.document = JSON.parse(payload.document);\n    msg.payload = payload;\n    node.status({ fill:\"green\", shape:\"dot\", text: msg.topic });\n}\ncatch(e) {\n    console.log('Parse error: ' + e)\n    node.error('Parse error: ' + e)\n    node.status({ fill:\"red\", shape:\"dot\", text:e });\n}\n\nreturn msg;","outputs":"1","noerr":0,"x":488.0994567871094,"y":1417.6363525390625,"wires":[["efa96804.d483f8","aed7d27e.a8e13"]]},{"id":"efa96804.d483f8","type":"debug","z":"6e1cdd6e.93025c","name":"GRAVAR RECADO","active":true,"console":"false","complete":"true","x":708.0994567871094,"y":1417.6363525390625,"wires":[]},{"id":"76f3eedc.b2568","type":"e-mail","z":"6e1cdd6e.93025c","server":"smtp.gmail.com","port":"465","name":"","dname":"","x":868.0994567871094,"y":1577.6363525390625,"wires":[]},{"id":"29bcc13c.66d6fe","type":"function","z":"6e1cdd6e.93025c","name":"","func":"msg.from = \"pxa255@gmail.com\";\nmsg.to = \"alessandro.holanda@altamira.com.br\";\nmsg.cc = \"pxa255@gmail.com\";\nmsg.payload  = \"Testando 5 o envio de emails pelo node-red\";\nreturn msg;","outputs":1,"noerr":0,"x":688.0994567871094,"y":1577.6363525390625,"wires":[["76f3eedc.b2568","7138b085.4cc0d"]]},{"id":"7138b085.4cc0d","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"true","x":868.0994567871094,"y":1637.6363525390625,"wires":[]},{"id":"d070d6f0.7d3ed8","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":498.0994567871094,"y":1577.6363525390625,"wires":[["29bcc13c.66d6fe"]]},{"id":"86f78634.898f58","type":"catch","z":"6e1cdd6e.93025c","name":"","scope":null,"x":618.0994567871094,"y":1777.6363525390625,"wires":[["f1ccf77d.28b138"]]},{"id":"f1ccf77d.28b138","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"false","x":878.0994567871094,"y":1777.6363525390625,"wires":[]},{"id":"aed7d27e.a8e13","type":"function","z":"6e1cdd6e.93025c","name":"SQL","func":"var mssql = global.get('mssql');\n\nvar procedure_name = '[Recado].[Novo]'\n\nvar request = new mssql.Request(global.get('ERP'));\n\nrequest.input('id', mssql.VarChar(36), msg.payload.document.id)\nrequest.input('produto', mssql.VarChar(50), msg.payload.document.produto)\nrequest.input('cliente', mssql.VarChar(50), msg.payload.document.cliente)\nrequest.input('empresa', mssql.VarChar(50), msg.payload.document.empresa)\nrequest.input('endereco', mssql.VarChar(50), msg.payload.document.endereco)\nrequest.input('numero', mssql.VarChar(10), msg.payload.document.numero)\nrequest.input('complemento', mssql.VarChar(50), msg.payload.document.complemento)\nrequest.input('contato', mssql.VarChar(50), msg.payload.document.contato)\nrequest.input('ddd', mssql.VarChar(2), msg.payload.document.ddd)\nrequest.input('telefone', mssql.VarChar(10), msg.payload.document.telefone)\nrequest.input('representante', mssql.VarChar(50), msg.payload.document.representante.codigo)\nrequest.input('regiao', mssql.VarChar(50), msg.payload.document.regiao)\n\nrequest.execute(procedure_name).then(function(recordsets, returnValue, affected) {\n\n    if (Array.isArray(recordsets) && recordsets.length > 0) {\n    \n        if (Array.isArray(recordsets[0]) && recordsets[0].length > 0 && recordsets[0][0].numero === 0) {\n\n            node.status({ fill:\"green\", shape:\"dot\", text: 'Recado incluido ok.' });\n\n            node.send({req: msg.req, res: msg.res, payload: recordsets[1][0]});\n        } else {\n            node.status({ fill:\"red\", shape:\"dot\", text: recordsets[0][0].mensagem || 'Erro desconhecido' });\n            \n            node.send({statusCode: 500, req: msg.req, res: msg.res, payload: recordsets[0][0]});\n        }\n        \n    } else {\n        node.status({ fill:\"red\", shape:\"dot\", text: recordsets[0][0].mensagem || 'Erro desconhecido' });\n        \n        return {statusCode: 500, req: msg.req, res: msg.res, payload: {number: -1, message: 'Internal server error: invalid response from database.'}};\n    }\n\n})\n.catch(function(err) {\n    console.log('-----------------> Erro ao chamar Stored Procedure ' + procedure_name + ' <-----------------')\n    console.log(JSON.stringify(err !== null && typeof err === 'object' && err))\n    msg.payload = err !== null && typeof err === 'object' ? err : { erro: 9999, mensagem: err || 'Erro desconhecido.' };\n    node.status({ fill:\"red\", shape:\"dot\", text: err !== null && typeof err === 'object' ? err.message : err });\n    node.send(msg);\n});","outputs":1,"noerr":0,"x":668.0994567871094,"y":1477.6363525390625,"wires":[["6fab656e.ce76ac"]]},{"id":"6fab656e.ce76ac","type":"debug","z":"6e1cdd6e.93025c","name":"RECADO GRAVADO","active":true,"console":"false","complete":"true","x":878.0994567871094,"y":1477.6363525390625,"wires":[]},{"id":"b8103a11.b343d8","type":"e-mail","z":"6e1cdd6e.93025c","server":"smtp.gmail.com","port":"465","name":"","dname":"","x":928.0994567871094,"y":1217.6363525390625,"wires":[]},{"id":"40b3f82.02de208","type":"function","z":"6e1cdd6e.93025c","name":"template","func":"msg.payload = \n`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>Recado</title>\n</head>\n<body>\n\n    <div>\n        <h2>Recado</h2>\n        <table>\n            <tr>\n                <td><b>Produto</b></td>\n                <td><nobr>${msg.payload.document.produto}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Cliente</b></td>\n                <td><nobr>${msg.payload.document.cliente}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Empresa</b></td>\n                <td><nobr>${msg.payload.document.empresa}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>EndereÃ§o</b></td>\n                <td><nobr>${msg.payload.document.endereco}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Numero</b></td>\n                <td><nobr>${msg.payload.document.numero}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Complemento</b></td>\n                <td><nobr>${msg.payload.document.complemento}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Contato</b></td>\n                <td><nobr>${msg.payload.document.contato}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Telefone</b></td>\n                <td><nobr>(${msg.payload.document.ddd}) ${msg.payload.document.telefone}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>RegiÃ£o</b></td>\n                <td><nobr>${msg.payload.document.regiao}</nobr></td>\n            </tr>\n        </table>\n    </div>\n\n</body>\n</html>\n`\nreturn msg;","outputs":1,"noerr":0,"x":658.0994567871094,"y":1257.6363525390625,"wires":[["7fa242c1.979a0c","b8103a11.b343d8"]]},{"id":"22f8853c.a833ca","type":"mqtt-broker","z":"","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""}]
