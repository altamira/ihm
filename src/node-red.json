[{"id":"dd7c3d4d.544e1","type":"inject","z":"6e1cdd6e.93025c","name":"Start ","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":1493.5357971191406,"y":144.6428623199463,"wires":[["b53e3116.967c1"]]},{"id":"b53e3116.967c1","type":"function","z":"6e1cdd6e.93025c","name":"CONEXAO COM SERVIDOR","func":"var mssql = global.get('mssql');\n\nvar PRODUCAO = new mssql.Connection(\"mssql://financeiro:financeiro@192.168.0.1/FINANCEIRO\", function(err) {\n    if (err) {\n        console.dir('-------------> ERRO NA CONEXAO PRODUCAO !!!!!! <-------------')\n        node.status({fill:\"red\",shape:\"dot\",text:'ERRO'});\n    } else {\n        global.set('PRODUCAO', PRODUCAO);\n        console.dir('CONECTADO AO SERVIDOR !')\n        node.status({fill:\"blue\",shape:\"dot\",text:'CONECTADO'});\n        PRODUCAO.on('error', function(err) {\n            node.error({payload: err || { erro: 9996, mensagem: 'Erro desconhecido na conexão'}})\n        });\n        \n    }\n});\n","outputs":1,"noerr":0,"x":1836.5357971191406,"y":144.64285469055176,"wires":[["a0e0a2b1.523d3"]]},{"id":"a0e0a2b1.523d3","type":"debug","z":"6e1cdd6e.93025c","name":"CONEXAO C/ SERVIDOR","active":true,"console":"false","complete":"payload","x":2116.2857971191406,"y":144.14286041259766,"wires":[]},{"id":"e795e417.f370f8","type":"http in","z":"6e1cdd6e.93025c","name":"maquinas listar","url":"/api/maquina/","method":"get","swaggerDoc":"","x":131.99999237060547,"y":211.99998950958252,"wires":[["dabd7ec1.8f9dc"]]},{"id":"e2035132.003f5","type":"http response","z":"6e1cdd6e.93025c","name":"","x":608.9999561309814,"y":211.9999885559082,"wires":[]},{"id":"dabd7ec1.8f9dc","type":"function","z":"6e1cdd6e.93025c","name":"Parametro Iniciais","func":"var myDate = new Date().toTimeString().replace(/.*(\\d{2}:\\d{2}:\\d{2}).*/, \"$1\");\n\nvar d = new Date();\nvar x = (\"00\" + (d.getMonth() + 1)).slice(-2) + \"/\" + \n        (\"00\" + d.getDate()).slice(-2) + \"/\" + \n        d.getFullYear() + \" \" + myDate;\n\nmsg.payload = \n[\n  {\n    \"_id\": \"Aplanadora-N3\",\n    \"codigo\": \"PERF-N3\",\n    \"nome\": \"Aplanadora N3\",\n    \"path\": \"maquinas/perfiladeiras/n3\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.230\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.231\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.232\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n    \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9978,\n        \"resolucao\": 2500,\n        \"perimetro\": 400\n      },\n      \"manual\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 95,\n        \"paradaEntrePecasProduzidas\": 0,\n        \"tempoParada\": 0\n      },\n      \"transmissao\": {\n        \"reducao\": 0,\n        \"diametrorolo\": 0,\n        \"avancoMilimetrosPorRotacao\": 9.5144\n      },\n      \"corte\":{\n        \"espessura\": 0,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"passoN2\": 200,\n        \"passoN3\": 200,\n        \"passoN5\": 200\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"10095646\",\n        \"produto\": {\n          \"codigo\": \"ESTCAN000N300000000#2000#0#0\",\n          \"descricao\": \"CANTONEIRA N-3 2000MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"produzindo\"\n      },\n      {\n        \"numero\": \"10095645\",\n        \"produto\": {\n          \"codigo\": \"ESTCAN000N300000000#2400#0#0\",\n          \"descricao\": \"CANTONEIRA N-3 2400MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"pendente\"\n      }\n    ]\n  },\n  {\n    \"_id\": \"Perfiladeira Reforco\",\n    \"codigo\": \"REFORCO\",\n    \"nome\": \"Perfiladeira Reforco\",\n    \"path\": \"maquinas/perfiladeiras/reforco\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.233\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.234\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.235\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n     \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9986,\n        \"resolucao\": 2500,\n        \"perimetro\": 127.32\n      },\n      \"manual\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"0.6\",\n        \"desaceleracao\": \"0.6\",\n        \"velocidade\": 95,\n        \"paradaEntrePecasProduzidas\": 20,\n        \"tempoParada\": 10\n      },\n      \"transmissao\": {\n        \"reducao\": 0,\n        \"diametrorolo\": 0,\n        \"avancoMilimetrosPorRotacao\": 9.5144\n      },\n      \"corte\":{\n        \"espessura\": 5,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"corte\": 1,\n        \"furo\": 20\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"1231-11\",\n        \"produto\": {\n          \"codigo\": \"PPLESTREFOUGAL000000#0#0#610\",\n          \"descricao\": \"PERFIL U GALV P/ APOIO DE CAIXA MED 610MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-11T11:22:08.224Z\",\n        \"status\": \"produzindo\"\n      },\n      {\n        \"numero\": \"8792-55\",\n        \"produto\": {\n          \"codigo\": \"PPLESTREFOUGAL000000#0#0#910\",\n          \"descricao\": \"PERFIL U GALV P/ APOIO DE CAIXA MED 910MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"pendente\"\n      }\n    ]\n  },\n    {\n    \"_id\": \"Perfiladeira Sigma 120\",\n    \"codigo\": \"Sigma 120\",\n    \"nome\": \"Perfiladeira Sigma 120\",\n    \"path\": \"maquinas/perfiladeiras/sigma120\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.236\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.237\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.238\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n     \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9909,\n        \"resolucao\": 2500,\n        \"perimetro\": 400\n      },\n      \"manual\": {\n        \"aceleracao\": \"3\",\n        \"desaceleracao\": \"1\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"2\",\n        \"desaceleracao\": \"1\",\n        \"velocidade\": 100,\n        \"paradaEntrePecasProduzidas\": 40,\n        \"tempoParada\": 2\n      },\n      \"transmissao\": {\n        \"reducao\": \"72.73\",\n        \"diametrorolo\": 165,\n        \"avancoMilimetrosPorRotacao\": 0\n      },\n      \"corte\":{\n        \"espessura\": 5,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"corte\": 1\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"1231-11\",\n        \"produto\": {\n          \"codigo\": \"MEZSIG0CH1412000000#1800#0#0\",\n          \"descricao\": \"VIGA SIGMA 120 CH 2.00 MM MED 1800MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2017-04-10T11:22:08.224Z\",\n        \"status\": \"Produzindo\"\n      },\n      {\n        \"numero\": \"8792-55\",\n        \"produto\": {\n          \"codigo\": \"PPLSTRSI120050D00000#1200#0#0\",\n          \"descricao\": \"STOP TRAZEIRO SIGMA 120 DEITADO MED 1200MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2017-04-14T11:22:08.224Z\",\n        \"status\": \"Pendente\"\n      }\n    ]\n  }\n]\nnode.status({fill:\"blue\",shape:\"dot\",text:x});\nreturn msg;","outputs":1,"noerr":0,"x":378.00001525878906,"y":212.99999809265137,"wires":[["e2035132.003f5"]]},{"id":"1ea0925b.801eee","type":"http in","z":"6e1cdd6e.93025c","name":"maquinas alterar","url":"/api/maquina/","method":"put","swaggerDoc":"","x":140,"y":300,"wires":[["66f66c9a.bdb4a4"]]},{"id":"599d869d.a3fab8","type":"http response","z":"6e1cdd6e.93025c","name":"","x":610,"y":300,"wires":[]},{"id":"69f4cdf4.ed9f74","type":"function","z":"6e1cdd6e.93025c","name":"SQL","func":"return msg;","outputs":1,"noerr":0,"x":390,"y":300,"wires":[["599d869d.a3fab8"]]},{"id":"12239c2f.f66a04","type":"http in","z":"6e1cdd6e.93025c","name":"maquinas incluir","url":"/api/maquina/","method":"post","swaggerDoc":"","x":140,"y":260,"wires":[["66f66c9a.bdb4a4"]]},{"id":"911313cd.172d8","type":"http response","z":"6e1cdd6e.93025c","name":"","x":610,"y":260,"wires":[]},{"id":"8bbe839e.6137","type":"function","z":"6e1cdd6e.93025c","name":"SQL","func":"return msg;","outputs":1,"noerr":0,"x":390,"y":260,"wires":[["911313cd.172d8"]]},{"id":"fa9e33fe.a503a","type":"function","z":"6e1cdd6e.93025c","name":"Lista de maquinas","func":"msg.payload = \n{\n\"_id\": \"Maquinas\",\n    \"Aplanadora-N3\": {\n      \"IP-IHM\" : \"192.168.2.230\",\n      \"IP-POP7\": \"192.168.2.235\",\n      \"IP-ESP8266\" : \"\",\n      \"Atualizacao\" : \"2017-03-09T11:44:56.224Z\",\n      \"parametros\": {\n          \"encoder\": {\n              \"fator\": 9998,\n              \"resolucao\": 2500,\n              \"perimetro\": 400\n          },\n          \"velocidade\": {\n              \"automatico\": 100,\n              \"manual\": 30\n          },\n          \"ferramenta\": {\n              \"passo\": 200\n          },\n          \"lubrificacao\": {\n              \"preset\": {\n                  \"MbNovoCiclos\": 100000\n              },\n              \"ciclos\": {\n                  \"PrsCiclos\": 5000\n              }\n          }\n      },\n      \"estado\": {\n          \"situacao\": {\n              \"codigo\": 4,\n              \"descricao\": \"Maquina OK\"\n          }\n      },\n      \"operadores\": {\n          \"IRANILDO\": {\n            \"md5\": \"93d8659ef7a80a65d1434366d96c8e13\"\n          },\n          \"MARCELO\": {\n            \"md5\": \"995bf053c4694e1e353cfd42b94e4447\"\n          }\n      },\n      \"os\": {\n          \"1231-11\": {\n            \"produto\": {\n                \"codigo\": \"XXXXXXXXX\",\n                \"descricao\": \"AAAAAABBBBBCCCCC\",\n                \"quantidade\": 1550,\n                \"produzido\": 299,\n                \"refugo\": 2\n            },\n            \"status\": \"produzindo\"\n          },\n          \"8792-55\": {\n            \"produto\": {\n                \"codigo\": \"XXXXXXXXX\",\n                \"descricao\": \"AAAAAABBBBBCCCCC\",\n                \"quantidade\": 700,\n                \"produzido\": 10,\n                \"refugo\": 10\n            },\n            \"status\": \"pendente\"\n          }\n      }\n    },\n    \"Perfiladeira-Reforço\": {\n      \"IP-IHM\" : \"192.168.2.220\",\n      \"IP-POP7\": \"192.168.2.211\",\n      \"IP-ESP8266\" : \"\",\n      \"Atualizacao\" : \"2015-02-10T11:22:08.224Z\",\n      \"parametros\": {\n          \"encoder\": {\n              \"fator\": 9998,\n              \"resolucao\": 2500,\n              \"perimetro\": 400\n          },\n          \"velocidade\": {\n              \"automatico\": 100,\n              \"manual\": 30\n          },\n          \"ferramenta\": {\n              \"passo\": 200\n          },\n          \"lubrificacao\": {\n              \"preset\": {\n                  \"MbNovoCiclos\": 100000\n              },\n              \"ciclos\": {\n                  \"PrsCiclos\": 5000\n              }\n          }\n      },\n      \"estado\": {\n          \"situacao\": {\n              \"codigo\": 1,\n              \"descricao\": \"Desligada\"\n          }\n      },\n      \"operadores\": {\n          \"IRANILDO\": {\n            \"md5\": \"93d8659ef7a80a65d1434366d96c8e13\"\n          },\n          \"MARCELO\": {\n            \"md5\": \"995bf053c4694e1e353cfd42b94e4447\"\n          }\n      },\n      \"os\": {\n          \"9999-44\": {\n            \"produto\": {\n                \"codigo\": \"QQQQQQQQQQQQ\",\n                \"descricao\": \"KKKKKKKBBBBBCCCCC\",\n                \"quantidade\": 350,\n                \"produzido\": 350,\n                \"refugo\": 0\n            },\n            \"status\": \"finalizado\"\n          },\n          \"6662-00\": {\n            \"produto\": {\n                \"codigo\": \"YYYYYYY\",\n                \"descricao\": \"GGGGGGBBBBBCCCCC\",\n                \"quantidade\": 150,\n                \"produzido\": 155,\n                \"refugo\": 5\n            },\n            \"status\": \"finalizado\"\n          }\n      }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":384,"y":460.9999771118164,"wires":[["52fe9e32.0fac2"]]},{"id":"52fe9e32.0fac2","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"false","x":625.5,"y":461,"wires":[]},{"id":"a4a5db9d.648798","type":"inject","z":"6e1cdd6e.93025c","name":"mostrar JSON","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":147.5,"y":461.00000762939453,"wires":[["fa9e33fe.a503a"]]},{"id":"6ce018bc.1db698","type":"http in","z":"6e1cdd6e.93025c","name":"login","url":"/api/usuario/login","method":"post","swaggerDoc":"","x":874.4444046020508,"y":644.0000247955322,"wires":[["c50601c1.718e2","8ae53ca1.a31e7"]]},{"id":"17fb7726.cd2f69","type":"http response","z":"6e1cdd6e.93025c","name":"","x":1224.8889694213867,"y":638.0000247955322,"wires":[]},{"id":"904305d0.e512c8","type":"http in","z":"6e1cdd6e.93025c","name":"/api/maquina/config/load","url":"/api/maquina/config","method":"get","swaggerDoc":"","x":1527.8054542541504,"y":236.1666660308838,"wires":[["8d2e240f.e24ab8"]]},{"id":"8d2e240f.e24ab8","type":"function","z":"6e1cdd6e.93025c","name":"Carrega parametros","func":"msg.payload = {\n    id: 123,\n    codigo: 'PERF-N3',\n    nome: 'Cantoneira N3',\n    path: 'maquinas/perfiladeiras/n3'\n};\n\nnode.status({fill:\"blue\",shape:\"dot\",text:msg.payload.codigo});\n// comentar essa linha\nmsg.payload = null;\n\nreturn msg;","outputs":1,"noerr":0,"x":1837.805461883545,"y":236.1666660308838,"wires":[["ae997d5f.cdebc","964f64ff.539ef8"]]},{"id":"ae997d5f.cdebc","type":"http response","z":"6e1cdd6e.93025c","name":"","x":2059.0276374816895,"y":236.1666774749756,"wires":[]},{"id":"c50601c1.718e2","type":"debug","z":"6e1cdd6e.93025c","name":"disparo ","active":true,"console":"false","complete":"payload","x":1046.3889694213867,"y":690.0000247955322,"wires":[]},{"id":"7b10a930.c678c8","type":"debug","z":"6e1cdd6e.93025c","name":"resposta SQL","active":true,"console":"false","complete":"payload","x":1254.8889694213867,"y":686.0000247955322,"wires":[]},{"id":"8ae53ca1.a31e7","type":"function","z":"6e1cdd6e.93025c","name":"senha","func":"\nvar msg2 = {};\nmsg2.payload = msg.payload.senha;\n\nmsg.payload = {\n    id: 123,\n    usuario: 'rita',\n    senha: '2794d223f90059c9f705c73a99384085',\n    nome: 'rita'\n};\n\nreturn [msg,msg2];","outputs":"2","noerr":0,"x":1035.8889694213867,"y":644.0000247955322,"wires":[["17fb7726.cd2f69","7b10a930.c678c8"],[]]},{"id":"964f64ff.539ef8","type":"debug","z":"6e1cdd6e.93025c","name":"resposta mongo config","active":true,"console":"false","complete":"payload","x":2106.8054237365723,"y":197.49999237060547,"wires":[]},{"id":"8e1e1701.47ab68","type":"debug","z":"6e1cdd6e.93025c","name":"IHM pedindo config","active":true,"console":"false","complete":"payload","x":414.99999237060547,"y":681.9999942779541,"wires":[]},{"id":"bf4d7693.b5a9e8","type":"comment","z":"6e1cdd6e.93025c","name":"Node-red Local","info":"","x":1128.8889694213867,"y":600.0000247955322,"wires":[]},{"id":"66f66c9a.bdb4a4","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"payload","x":418.99998474121094,"y":351.99999237060547,"wires":[]},{"id":"a0d97272.d60cd","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":160,"wires":[["dabd7ec1.8f9dc"]]},{"id":"ff875db0.15f9d","type":"comment","z":"6e1cdd6e.93025c","name":"API DO SERVIDOR - 192.168.0.1","info":"","x":1549.5357971191406,"y":106.64286231994629,"wires":[]},{"id":"3e68b06c.f32af","type":"comment","z":"6e1cdd6e.93025c","name":"API DA IHM - 127.0.0.1/localhost","info":"","x":190,"y":400,"wires":[]},{"id":"9df23dbb.d454e","type":"http in","z":"6e1cdd6e.93025c","name":"/api/maquina/config/save","url":"/api/maquina/config","method":"post","swaggerDoc":"","x":131.99998474121094,"y":639.000020980835,"wires":[["e398e361.438b68","8e1e1701.47ab68"]]},{"id":"e398e361.438b68","type":"http response","z":"6e1cdd6e.93025c","name":"","x":530,"y":640,"wires":[]},{"id":"f40eac61.74178","type":"md5","z":"6e1cdd6e.93025c","name":"","fieldToHash":"payload","fieldTypeToHash":"msg","hashField":"md5","hashFieldType":"msg","x":960,"y":200,"wires":[["ca3721f6.51b8"]]},{"id":"fe3d4e02.6aec5","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"HELIO","payloadType":"str","repeat":"","crontab":"","once":false,"x":810,"y":200,"wires":[["f40eac61.74178"]]},{"id":"ca3721f6.51b8","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"true","x":1110,"y":200,"wires":[]},{"id":"8f7c090b.4c6718","type":"e-mail","z":"6e1cdd6e.93025c","server":"smtp.gmail.com","port":"465","name":"","dname":"","x":740,"y":827,"wires":[]},{"id":"a661bee8.f94f","type":"function","z":"6e1cdd6e.93025c","name":"","func":"msg.from = \"pxa255@gmail.com\";\nmsg.to = \"marcelo.miranda@tecnequip.com.br\";\nmsg.cc = \"pxa255@gmail.com\";\nmsg.payload  = \"Testando 4 o envio de emails pelo node-red\";\nreturn msg;","outputs":1,"noerr":0,"x":577,"y":827,"wires":[["8f7c090b.4c6718","98451890.645b28"]]},{"id":"98451890.645b28","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"true","x":738,"y":877,"wires":[]},{"id":"4cc76b95.e73bc4","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":435,"y":826.9999923706055,"wires":[["a661bee8.f94f"]]},{"id":"1e8ce248.23647e","type":"e-mail in","z":"6e1cdd6e.93025c","name":"pxa255@gmail.com","protocol":"IMAP","server":"imap.gmail.com","useSSL":true,"port":"993","box":"INBOX","disposition":"Read","repeat":"90","x":512.149284362793,"y":925.3688373565674,"wires":[["ead55fbc.95d6d"]]},{"id":"ead55fbc.95d6d","type":"debug","z":"6e1cdd6e.93025c","name":"recebidos","active":true,"console":"false","complete":"true","x":726.8606224060059,"y":924.5253829956055,"wires":[]},{"id":"91b8a711.fa64c8","type":"mqtt in","z":"6e1cdd6e.93025c","name":"enviar email","topic":"+/task/completed/sendTask/Task_1d9liyj/#","qos":"2","broker":"22f8853c.a833ca","x":265.0993995666504,"y":1085.6362781524658,"wires":[["7aa239d5.ffa998"]]},{"id":"7aa239d5.ffa998","type":"function","z":"6e1cdd6e.93025c","name":"parse","func":"try {\n    let payload = JSON.parse(msg.payload);\n    payload.document = JSON.parse(payload.document);\n    msg.payload = payload;\n    msg.from = 'orcamento@altamira.com.br'\n    msg.to = 'alessandro@altamira.com.br' //msg.payload.document.representante.email\n    msg.topic = 'Recado: ' + msg.payload.document.empresa;\n    node.status({ fill:\"green\", shape:\"dot\", text: msg.topic });\n}\ncatch(e) {\n    console.log('Parse error: ' + e)\n    node.error('Parse error: ' + e)\n    node.status({ fill:\"red\", shape:\"dot\", text: e.message });\n}\n\nreturn msg;","outputs":"1","noerr":0,"x":445.0993995666504,"y":1085.6362781524658,"wires":[["3af0e500.be9bcc","40b3f82.02de208"]]},{"id":"7fa242c1.979a0c","type":"debug","z":"6e1cdd6e.93025c","name":"EMAIL RECADO","active":true,"console":"false","complete":"true","x":925.0993995666504,"y":1085.6362781524658,"wires":[]},{"id":"3d1a8181.4baabe","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":635.0993995666504,"y":1045.6362781524658,"wires":[["b8103a11.b343d8"]]},{"id":"3af0e500.be9bcc","type":"debug","z":"6e1cdd6e.93025c","name":"EMAIL RECADO","active":true,"console":"false","complete":"true","x":655.0994300842285,"y":997.6362838745117,"wires":[]},{"id":"fbf811fa.f8082","type":"mqtt in","z":"6e1cdd6e.93025c","name":"gravar recado","topic":"+/task/completed/userTask/Task_1mfcqmp/#","qos":"2","broker":"22f8853c.a833ca","x":268.0994682312012,"y":1159.6363153457642,"wires":[["ed460395.4dc7e"]]},{"id":"ed460395.4dc7e","type":"function","z":"6e1cdd6e.93025c","name":"parse","func":"try {\n    let payload = JSON.parse(msg.payload);\n    payload.document = JSON.parse(payload.document);\n    msg.payload = payload;\n    node.status({ fill:\"green\", shape:\"dot\", text: msg.topic });\n}\ncatch(e) {\n    console.log('Parse error: ' + e)\n    node.error('Parse error: ' + e)\n    node.status({ fill:\"red\", shape:\"dot\", text:e });\n}\n\nreturn msg;","outputs":"1","noerr":0,"x":448.0994682312012,"y":1159.6363153457642,"wires":[["efa96804.d483f8","aed7d27e.a8e13"]]},{"id":"efa96804.d483f8","type":"debug","z":"6e1cdd6e.93025c","name":"GRAVAR RECADO","active":true,"console":"false","complete":"true","x":668.0994682312012,"y":1159.6363153457642,"wires":[]},{"id":"76f3eedc.b2568","type":"e-mail","z":"6e1cdd6e.93025c","server":"smtp.gmail.com","port":"465","name":"pxa255@gmail.com","dname":"","x":847.0994281768799,"y":1303.6363067626953,"wires":[]},{"id":"29bcc13c.66d6fe","type":"function","z":"6e1cdd6e.93025c","name":"","func":"msg.from = \"pxa255@gmail.com\";\nmsg.to = \"alessandro.holanda@altamira.com.br\";\nmsg.cc = \"pxa255@gmail.com\";\nmsg.payload  = \"Testando 5 o envio de emails pelo node-red\";\nreturn msg;","outputs":1,"noerr":0,"x":627.0994281768799,"y":1303.6363067626953,"wires":[["76f3eedc.b2568","7138b085.4cc0d"]]},{"id":"7138b085.4cc0d","type":"debug","z":"6e1cdd6e.93025c","name":"","active":true,"console":"false","complete":"true","x":807.0994281768799,"y":1363.6363067626953,"wires":[]},{"id":"d070d6f0.7d3ed8","type":"inject","z":"6e1cdd6e.93025c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":437.0994281768799,"y":1303.6363067626953,"wires":[["29bcc13c.66d6fe"]]},{"id":"86f78634.898f58","type":"catch","z":"6e1cdd6e.93025c","name":"","scope":["76f3eedc.b2568","1e8ce248.23647e","b8103a11.b343d8","8f7c090b.4c6718"],"x":567.0994281768799,"y":1503.6363067626953,"wires":[["f1ccf77d.28b138"]]},{"id":"f1ccf77d.28b138","type":"debug","z":"6e1cdd6e.93025c","name":"email","active":true,"console":"false","complete":"true","x":797.0994281768799,"y":1503.6363067626953,"wires":[]},{"id":"aed7d27e.a8e13","type":"function","z":"6e1cdd6e.93025c","name":"SQL","func":"var mssql = global.get('mssql');\n\nvar procedure_name = '[Recado].[Novo]'\n\nvar request = new mssql.Request(global.get('ERP'));\n\nrequest.input('id', mssql.VarChar(36), msg.payload.document.id)\nrequest.input('produto', mssql.VarChar(50), msg.payload.document.produto)\nrequest.input('cliente', mssql.VarChar(50), msg.payload.document.cliente)\nrequest.input('empresa', mssql.VarChar(50), msg.payload.document.empresa)\nrequest.input('endereco', mssql.VarChar(50), msg.payload.document.endereco)\nrequest.input('numero', mssql.VarChar(10), msg.payload.document.numero)\nrequest.input('complemento', mssql.VarChar(50), msg.payload.document.complemento)\nrequest.input('contato', mssql.VarChar(50), msg.payload.document.contato)\nrequest.input('ddd', mssql.VarChar(2), msg.payload.document.ddd)\nrequest.input('telefone', mssql.VarChar(10), msg.payload.document.telefone)\nrequest.input('representante', mssql.VarChar(50), msg.payload.document.representante.codigo)\nrequest.input('regiao', mssql.VarChar(50), msg.payload.document.regiao)\n\nrequest.execute(procedure_name).then(function(recordsets, returnValue, affected) {\n\n    if (Array.isArray(recordsets) && recordsets.length > 0) {\n    \n        if (Array.isArray(recordsets[0]) && recordsets[0].length > 0 && recordsets[0][0].numero === 0) {\n\n            node.status({ fill:\"green\", shape:\"dot\", text: 'Recado incluido ok.' });\n\n            node.send({req: msg.req, res: msg.res, payload: recordsets[1][0]});\n        } else {\n            node.status({ fill:\"red\", shape:\"dot\", text: recordsets[0][0].mensagem || 'Erro desconhecido' });\n            \n            node.send({statusCode: 500, req: msg.req, res: msg.res, payload: recordsets[0][0]});\n        }\n        \n    } else {\n        node.status({ fill:\"red\", shape:\"dot\", text: recordsets[0][0].mensagem || 'Erro desconhecido' });\n        \n        return {statusCode: 500, req: msg.req, res: msg.res, payload: {number: -1, message: 'Internal server error: invalid response from database.'}};\n    }\n\n})\n.catch(function(err) {\n    console.log('-----------------> Erro ao chamar Stored Procedure ' + procedure_name + ' <-----------------')\n    console.log(JSON.stringify(err !== null && typeof err === 'object' && err))\n    msg.payload = err !== null && typeof err === 'object' ? err : { erro: 9999, mensagem: err || 'Erro desconhecido.' };\n    node.status({ fill:\"red\", shape:\"dot\", text: err !== null && typeof err === 'object' ? err.message : err });\n    node.send(msg);\n});","outputs":1,"noerr":0,"x":628.0994682312012,"y":1219.6363153457642,"wires":[["6fab656e.ce76ac"]]},{"id":"6fab656e.ce76ac","type":"debug","z":"6e1cdd6e.93025c","name":"RECADO GRAVADO","active":true,"console":"false","complete":"true","x":838.0994682312012,"y":1219.6363153457642,"wires":[]},{"id":"b8103a11.b343d8","type":"e-mail","z":"6e1cdd6e.93025c","server":"smtp.gmail.com","port":"465","name":"pxa255@gmail.com","dname":"","x":925.0993995666504,"y":1045.6362781524658,"wires":[]},{"id":"40b3f82.02de208","type":"function","z":"6e1cdd6e.93025c","name":"template","func":"msg.payload = \n`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>Recado</title>\n</head>\n<body>\n\n    <div>\n        <h2>Recado</h2>\n        <table>\n            <tr>\n                <td><b>Produto</b></td>\n                <td><nobr>${msg.payload.document.produto}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Cliente</b></td>\n                <td><nobr>${msg.payload.document.cliente}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Empresa</b></td>\n                <td><nobr>${msg.payload.document.empresa}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Endereço</b></td>\n                <td><nobr>${msg.payload.document.endereco}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Numero</b></td>\n                <td><nobr>${msg.payload.document.numero}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Complemento</b></td>\n                <td><nobr>${msg.payload.document.complemento}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Contato</b></td>\n                <td><nobr>${msg.payload.document.contato}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Telefone</b></td>\n                <td><nobr>(${msg.payload.document.ddd}) ${msg.payload.document.telefone}</nobr></td>\n            </tr>\n            <tr>\n                <td><b>Região</b></td>\n                <td><nobr>${msg.payload.document.regiao}</nobr></td>\n            </tr>\n        </table>\n    </div>\n\n</body>\n</html>\n`\nreturn msg;","outputs":1,"noerr":0,"x":615.0993995666504,"y":1085.6362781524658,"wires":[["7fa242c1.979a0c","b8103a11.b343d8"]]},{"id":"1c279d89.8348c2","type":"http response","z":"6e1cdd6e.93025c","name":"","x":968.5000152587891,"y":1687.1590576171875,"wires":[]},{"id":"747bc885.d83388","type":"http in","z":"6e1cdd6e.93025c","name":"Index","url":"/sitio","method":"get","swaggerDoc":"","x":217.94437281290675,"y":1687.2701195610894,"wires":[["60aeb9e5.e296a8"]]},{"id":"60aeb9e5.e296a8","type":"file in","z":"6e1cdd6e.93025c","name":"index.HTML","filename":"/home/marcelomiranda/git/sitio/build/index.html","format":"utf8","x":606.0554885864258,"y":1687.3812322616577,"wires":[["c1350238.459df","f9a8c27a.7e95e"]]},{"id":"74fbfee7.908d","type":"http response","z":"6e1cdd6e.93025c","name":"","x":968.9445012410488,"y":1807.8257064819336,"wires":[]},{"id":"20340c07.7ec184","type":"function","z":"6e1cdd6e.93025c","name":"Text/CSS","func":"msg.headers = { \"Content-type\" : \"text/css\" }\n \nreturn msg;","outputs":1,"noerr":0,"x":807.4999122619629,"y":1807.7145595550537,"wires":[["74fbfee7.908d"]]},{"id":"167c631c.51dd3d","type":"comment","z":"6e1cdd6e.93025c","name":"HTML","info":"","x":217.5,"y":1651.1590328216553,"wires":[]},{"id":"f839ca15.1e98b8","type":"comment","z":"6e1cdd6e.93025c","name":"CSS folder","info":"","x":228.38881301879883,"y":1771.2702922821045,"wires":[]},{"id":"8e9198b3.2bcac8","type":"comment","z":"6e1cdd6e.93025c","name":"JAVASCRIPT folder","info":"","x":257.83331298828125,"y":1850.7148065567017,"wires":[]},{"id":"6fd13e3c.f849a","type":"http response","z":"6e1cdd6e.93025c","name":"","x":968.9444630940761,"y":1888.2701263427734,"wires":[]},{"id":"a8f2ad6c.57e78","type":"http in","z":"6e1cdd6e.93025c","name":"Scripts","url":"/static/js/:file","method":"get","swaggerDoc":"","x":218.38882064819336,"y":1888.3811882866753,"wires":[["e580913c.f8dd8"]]},{"id":"975099ae.181d18","type":"comment","z":"6e1cdd6e.93025c","name":"media folder","info":"","x":237.61099243164062,"y":1937.3812046051025,"wires":[]},{"id":"f21f85e8.0e4b68","type":"http response","z":"6e1cdd6e.93025c","name":"","x":968.1666920979824,"y":1972.714729309082,"wires":[]},{"id":"ab0cf51c.d3ccc8","type":"http in","z":"6e1cdd6e.93025c","name":"media","url":"/static/media/:file","method":"get","swaggerDoc":"","x":217.6110496520996,"y":1972.825791252984,"wires":[["5b58f90f.165578"]]},{"id":"4ffc72a1.e2ef2c","type":"function","z":"6e1cdd6e.93025c","name":"media","func":"var ext = msg.filename.split('.')[msg.filename.split('.').length - 1]\n\nconsole.log('File extension: ' + ext)\n\nswitch(ext) {\n    case 'eot':\n        msg.headers = { \"Content-type\" : \"application/vnd.ms-fontobject\" }\n        break;\n    case 'svg':\n        msg.headers = { \"Content-type\" : \"image/svg+xml\" }\n        break;\n    case 'png':\n        msg.headers = { \"Content-type\" : \"image/png\" }\n        break;\n    case 'gif':\n        msg.headers = { \"Content-type\" : \"image/gif\" }\n        break;\n    case 'ico':\n        msg.headers = { \"Content-type\" : \"image/x-icon\" }\n        break;\n    case ('jpeg'||'jpg'):\n        msg.headers = { \"Content-type\" : \"image/jpeg\" }\n        break;\n    case 'ttf':\n        msg.headers = { \"Content-type\" : \"application/x-font-ttf\" }\n        break;\n    case 'woff':\n        msg.headers = { \"Content-type\" : \"application/font-woff\" }\n        break;\n    case 'woff2':\n        msg.headers = { \"Content-type\" : \"application/font-woff2\" }\n        break;\n    case 'otf':\n        msg.headers = { \"Content-type\" : \"application/x-font-opentype\" }\n        break;\n    case 'ttf':\n        msg.headers = { \"Content-type\" : \"application/font-sfnt\" }\n        break;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":799.388843536377,"y":1972.6036167144775,"wires":[["f21f85e8.0e4b68","d0a3713c.f21"]]},{"id":"c1350238.459df","type":"function","z":"6e1cdd6e.93025c","name":"Text/HTML","func":"msg.headers = { \"Content-type\" : \"text/html\" }\n\nreturn msg;","outputs":1,"noerr":0,"x":816.3332672119141,"y":1687.1802062988281,"wires":[["1c279d89.8348c2"]]},{"id":"cf400234.3a668","type":"http in","z":"6e1cdd6e.93025c","name":"CSS Files","url":"/static/css/:file","method":"get","swaggerDoc":"","x":229.29631423950195,"y":1807.4443367852105,"wires":[["85e54ad2.270c48"]]},{"id":"85e54ad2.270c48","type":"function","z":"6e1cdd6e.93025c","name":"files","func":"msg.filename = '//home//marcelomiranda//git//sitio//build//static//css//' + msg.req.params.file;\nreturn msg;","outputs":1,"noerr":0,"x":461.51855850219727,"y":1807.2221688164605,"wires":[["ff987f5e.d44c1"]]},{"id":"ff987f5e.d44c1","type":"file in","z":"6e1cdd6e.93025c","name":"","filename":"","format":"","x":627.740795135498,"y":1807.3333367241753,"wires":[["20340c07.7ec184","405741f4.c3b6"]]},{"id":"e580913c.f8dd8","type":"function","z":"6e1cdd6e.93025c","name":"files","func":"msg.filename = '//home//marcelomiranda//git//sitio//build//static//js//' + msg.req.params.file;\nreturn msg;","outputs":1,"noerr":0,"x":459.2683219909668,"y":1889.2776486873627,"wires":[["c28c9e81.a065d"]]},{"id":"5b58f90f.165578","type":"function","z":"6e1cdd6e.93025c","name":"files","func":"msg.filename = '//home//marcelomiranda//git//sitio//build//static//media//' + msg.req.params.file;\nreturn msg;","outputs":1,"noerr":0,"x":464.851863861084,"y":1972.5554093254937,"wires":[["2cecc41f.2680bc"]]},{"id":"c28c9e81.a065d","type":"file in","z":"6e1cdd6e.93025c","name":"","filename":"","format":"","x":628.185245513916,"y":1889.2221688164605,"wires":[["fc6936dc.58c488","6fd13e3c.f849a"]]},{"id":"fc6936dc.58c488","type":"debug","z":"6e1cdd6e.93025c","name":"FIles JS","active":false,"console":"false","complete":"filename","x":808.0741500854492,"y":1927.9999989403618,"wires":[]},{"id":"2cecc41f.2680bc","type":"file in","z":"6e1cdd6e.93025c","name":"","filename":"","format":"","x":630.407413482666,"y":1972.333130730523,"wires":[["4ffc72a1.e2ef2c"]]},{"id":"215efe62.8b8072","type":"http response","z":"6e1cdd6e.93025c","name":"","x":967.9445470174155,"y":1724.722046746148,"wires":[]},{"id":"a25a8bbb.1e0998","type":"http in","z":"6e1cdd6e.93025c","name":"Bootstrap","url":"/sitio","method":"get","swaggerDoc":"","x":226.3889045715332,"y":1724.8331086900498,"wires":[["d4b988e8.957588"]]},{"id":"d4b988e8.957588","type":"file in","z":"6e1cdd6e.93025c","name":"boostrap.min","filename":"/home/marcelomiranda/react-node-red/build/boostrap.min","format":"utf8","x":604.5000203450522,"y":1724.9442213906182,"wires":[["2d99b00b.d98a4"]]},{"id":"2d99b00b.d98a4","type":"function","z":"6e1cdd6e.93025c","name":"Text/CSS","func":"msg.headers = { \"Content-type\" : \"text/css\" }\n \nreturn msg;","outputs":1,"noerr":0,"x":806.5185508728027,"y":1724.4997996224297,"wires":[["215efe62.8b8072"]]},{"id":"405741f4.c3b6","type":"debug","z":"6e1cdd6e.93025c","name":"CSS files","active":false,"console":"false","complete":"true","x":808.4074745178223,"y":1852.5554207695855,"wires":[]},{"id":"824230e4.1736a","type":"comment","z":"6e1cdd6e.93025c","name":"Servidor WEB","info":"$options => i for case insensitive search\n\nStart with string\n\ndb.collection.find({zip:{'$regex' : '^string', '$options' : 'i'}})\nEnd with string\n\ndb.collection.find({zip:{'$regex' : 'string$', '$options' : 'i'}})\nContains string\n\ndb.collection.find({zip:{'$regex' : 'string', '$options' : 'i'}})\nDoesn't Contains string\n\ndb.collection.find({zip:{'$regex' : '^((?!string).)*$', '$options' : 'i'}})\nKeep this as a bookmark, and a reference for any other alterations you may need. http://www.cheatography.com/davechild/cheat-sheets/regular-expressions/","x":645.9629592895508,"y":1634.610836982727,"wires":[]},{"id":"f9a8c27a.7e95e","type":"debug","z":"6e1cdd6e.93025c","name":"saida","active":false,"console":"false","complete":"true","x":797.2499923706055,"y":1647.2924880981445,"wires":[]},{"id":"d0a3713c.f21","type":"debug","z":"6e1cdd6e.93025c","name":"Fonts Files","active":true,"console":"false","complete":"headers","x":989.749927520752,"y":2022.8409023284912,"wires":[]},{"id":"aeaa0727.f9d348","type":"inject","z":"6e1cdd6e.93025c","name":"Criar estrutura parametros","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1554.2764778137207,"y":347.5606174468994,"wires":[["533bf21b.f5baac"]]},{"id":"4fe5c768.8ffae8","type":"mongodb out","z":"6e1cdd6e.93025c","mongodb":"155a161b.16de0a","name":"salvar configmaq","collection":"config","payonly":true,"upsert":false,"multi":false,"operation":"store","x":2255.6338996887207,"y":348.30583477020264,"wires":[]},{"id":"4425a41d.306cec","type":"inject","z":"6e1cdd6e.93025c","name":"Criar estrutura log_erro","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1544.2539176940918,"y":393.6606740951538,"wires":[["33c92456.7d1e4c"]]},{"id":"8ca4724c.88329","type":"mongodb out","z":"6e1cdd6e.93025c","mongodb":"155a161b.16de0a","name":"salvar","collection":"log_erro","payonly":true,"upsert":false,"multi":false,"operation":"store","x":2041.6118049621582,"y":393.7115058898926,"wires":[]},{"id":"33c92456.7d1e4c","type":"function","z":"6e1cdd6e.93025c","name":"collection inicial log_erro","func":"var myDate = new Date().toTimeString().replace(/.*(\\d{2}:\\d{2}:\\d{2}).*/, \"$1\");\nvar d = new Date();\nvar x = (\"00\" + (d.getMonth() + 1)).slice(-2) + \"/\" + \n        (\"00\" + d.getDate()).slice(-2) + \"/\" + \n        d.getFullYear() + \" \" + myDate;\n        \nmsg.payload = {\n\t\"_id\": 1,\n\t\"log_mesagens\": {\n\t}\n}\nnode.status({fill:\"blue\",shape:\"dot\",text:x});\nreturn msg;","outputs":1,"noerr":0,"x":1834.620792388916,"y":393.81629276275635,"wires":[["8ca4724c.88329"]]},{"id":"87dff5c0.e149f8","type":"comment","z":"6e1cdd6e.93025c","name":"Cria estrutura inicial das coleções","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":1549.1426429748535,"y":310.9105987548828,"wires":[]},{"id":"bd8cd10c.aa4dd","type":"inject","z":"6e1cdd6e.93025c","name":"Criar estrutura indice","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":1533.7759132385254,"y":441.17737674713135,"wires":[["c6a60d17.efa75"]]},{"id":"18011941.912e17","type":"mongodb out","z":"6e1cdd6e.93025c","mongodb":"155a161b.16de0a","name":"salvar","collection":"indice","payonly":true,"upsert":false,"multi":true,"operation":"store","x":2041.6892929077148,"y":440.6727457046509,"wires":[]},{"id":"c6a60d17.efa75","type":"function","z":"6e1cdd6e.93025c","name":"collection inicial indice","func":"msg.payload = {\n\t\"_id\": \"indice\",\n\t\"indice_mesagens\": 0\n}\nvar x = msg.payload.indice_mesagens;\nnode.status({fill:\"blue\",shape:\"dot\",text:'Indice =' + x});\nreturn msg;","outputs":1,"noerr":0,"x":1835.1427879333496,"y":440.99960803985596,"wires":[["18011941.912e17"]]},{"id":"533bf21b.f5baac","type":"function","z":"6e1cdd6e.93025c","name":"Parametro Iniciais","func":"var myDate = new Date().toTimeString().replace(/.*(\\d{2}:\\d{2}:\\d{2}).*/, \"$1\");\n\nvar d = new Date();\nvar x = (\"00\" + (d.getMonth() + 1)).slice(-2) + \"/\" + \n        (\"00\" + d.getDate()).slice(-2) + \"/\" + \n        d.getFullYear() + \" \" + myDate;\n\nmsg.payload = \n[\n  {\n    \"_id\": \"Aplanadora-N3\",\n    \"codigo\": \"PERF-N3\",\n    \"nome\": \"Aplanadora N3\",\n    \"path\": \"maquinas/perfiladeiras/n3\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.230\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.231\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.232\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n    \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9978,\n        \"resolucao\": 2500,\n        \"perimetro\": 400\n      },\n      \"manual\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 95,\n        \"paradaEntrePecasProduzidas\": 0,\n        \"tempoParada\": 0\n      },\n      \"transmissao\": {\n        \"reducao\": 0,\n        \"diametrorolo\": 0,\n        \"avancoMilimetrosPorRotacao\": 9.5144\n      },\n      \"corte\":{\n        \"espessura\": 0,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"passoN2\": 200,\n        \"passoN3\": 200,\n        \"passoN5\": 200\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"10095646\",\n        \"produto\": {\n          \"codigo\": \"ESTCAN000N300000000#2000#0#0\",\n          \"descricao\": \"CANTONEIRA N-3 2000MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"produzindo\"\n      },\n      {\n        \"numero\": \"10095645\",\n        \"produto\": {\n          \"codigo\": \"ESTCAN000N300000000#2400#0#0\",\n          \"descricao\": \"CANTONEIRA N-3 2400MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"pendente\"\n      }\n    ]\n  },\n  {\n    \"_id\": \"Perfiladeira Reforco\",\n    \"codigo\": \"REFORCO\",\n    \"nome\": \"Perfiladeira Reforco\",\n    \"path\": \"maquinas/perfiladeiras/reforco\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.233\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.234\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.235\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n     \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9986,\n        \"resolucao\": 2500,\n        \"perimetro\": 127.32\n      },\n      \"manual\": {\n        \"aceleracao\": \"0.2\",\n        \"desaceleracao\": \"0.2\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"0.6\",\n        \"desaceleracao\": \"0.6\",\n        \"velocidade\": 95,\n        \"paradaEntrePecasProduzidas\": 20,\n        \"tempoParada\": 10\n      },\n      \"transmissao\": {\n        \"reducao\": 0,\n        \"diametrorolo\": 0,\n        \"avancoMilimetrosPorRotacao\": 9.5144\n      },\n      \"corte\":{\n        \"espessura\": 5,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"corte\": 1,\n        \"furo\": 20\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"1231-11\",\n        \"produto\": {\n          \"codigo\": \"PPLESTREFOUGAL000000#0#0#610\",\n          \"descricao\": \"PERFIL U GALV P/ APOIO DE CAIXA MED 610MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-11T11:22:08.224Z\",\n        \"status\": \"produzindo\"\n      },\n      {\n        \"numero\": \"8792-55\",\n        \"produto\": {\n          \"codigo\": \"PPLESTREFOUGAL000000#0#0#910\",\n          \"descricao\": \"PERFIL U GALV P/ APOIO DE CAIXA MED 910MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2015-02-10T11:22:08.224Z\",\n        \"status\": \"pendente\"\n      }\n    ]\n  },\n    {\n    \"_id\": \"Perfiladeira Sigma 120\",\n    \"codigo\": \"Sigma 120\",\n    \"nome\": \"Perfiladeira Sigma 120\",\n    \"path\": \"maquinas/perfiladeiras/sigma120\",\n    \"rede\": [\n      { \"nome\": \"IHM\", \"ip\": \"192.168.2.236\", \"port\": 8080 },\n      { \"nome\": \"POP7\", \"ip\": \"192.168.2.237\" },\n      { \"nome\": \"ESP8266\", \"ip\": \"192.168.2.238\" }\n    ],\n    \"atualizacao\": d.toISOString(),\n     \"parametros\": {\n      \"encoder\": {\n        \"fator\": 9909,\n        \"resolucao\": 2500,\n        \"perimetro\": 400\n      },\n      \"manual\": {\n        \"aceleracao\": \"3\",\n        \"desaceleracao\": \"1\",\n        \"velocidade\": 30\n      },\n      \"automatico\": {\n        \"aceleracao\": \"2\",\n        \"desaceleracao\": \"1\",\n        \"velocidade\": 100,\n        \"paradaEntrePecasProduzidas\": 40,\n        \"tempoParada\": 2\n      },\n      \"transmissao\": {\n        \"reducao\": \"72.73\",\n        \"diametrorolo\": 165,\n        \"avancoMilimetrosPorRotacao\": 0\n      },\n      \"corte\":{\n        \"espessura\": 5,\n        \"tempo\": 3\n      },\n      \"ferramenta\": {\n        \"corte\": 1\n      },\n      \"lubrificacao\": {\n        \"preset\": {\n          \"MbNovoCiclos\": 100000\n        },\n        \"ciclos\": {\n          \"PrsCiclos\": 5000\n        }\n      }\n    },\n    \"estado\": {\n      \"situacao\": {\n        \"codigo\": 4,\n        \"descricao\": \"Maquina OK\"\n      }\n    },\n    \"operadores\": [\n      { \"nome\": \"HELIO\", \"senha\": \"0aec9f876b8e62cba16c2704d99559d3\" },\n      { \"nome\": \"MARCELO\", \"senha\": \"99bb3473f26bb4814ea456d17af58f48\" }\n    ],\n    \"os\": [\n      {\n        \"numero\": \"1231-11\",\n        \"produto\": {\n          \"codigo\": \"MEZSIG0CH1412000000#1800#0#0\",\n          \"descricao\": \"VIGA SIGMA 120 CH 2.00 MM MED 1800MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2017-04-10T11:22:08.224Z\",\n        \"status\": \"Produzindo\"\n      },\n      {\n        \"numero\": \"8792-55\",\n        \"produto\": {\n          \"codigo\": \"PPLSTRSI120050D00000#1200#0#0\",\n          \"descricao\": \"STOP TRAZEIRO SIGMA 120 DEITADO MED 1200MM\",\n          \"quantidade\": 2,\n          \"produzido\": 0,\n          \"refugo\": 0\n        },\n        \"atualizacao\": \"2017-04-14T11:22:08.224Z\",\n        \"status\": \"Pendente\"\n      }\n    ]\n  }\n]\nnode.status({fill:\"blue\",shape:\"dot\",text:x});\nreturn msg;","outputs":1,"noerr":0,"x":1836.561191558838,"y":347.19695568084717,"wires":[["79c19aa7.3b3024"]]},{"id":"79c19aa7.3b3024","type":"split","z":"6e1cdd6e.93025c","name":"","splt":"\\n","x":2041.9553565979004,"y":347.5960922241211,"wires":[["4fe5c768.8ffae8"]]},{"id":"dae9234b.3858c","type":"mongodb out","z":"6e1cdd6e.93025c","mongodb":"155a161b.16de0a","name":"APAGAR TODA A COLLECTION log_erro","collection":"log_erro","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":1935.0000686645508,"y":583.7499828338623,"wires":[]},{"id":"6f5660a8.56215","type":"inject","z":"6e1cdd6e.93025c","name":"LIMPAR coleção log_erro","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"x":1559.7536163330078,"y":584.4770383834839,"wires":[["dae9234b.3858c"]]},{"id":"4eaae68a.d82838","type":"comment","z":"6e1cdd6e.93025c","name":"Apagar Cuidado","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":1506.333152770996,"y":495.5277795791626,"wires":[]},{"id":"608d0ef6.c50c3","type":"mongodb out","z":"6e1cdd6e.93025c","mongodb":"155a161b.16de0a","name":"APAGAR TODA A COLLECTION config","collection":"config","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":1933.4443130493164,"y":536.527753829956,"wires":[]},{"id":"cb51ab8e.c23b28","type":"inject","z":"6e1cdd6e.93025c","name":"LIMPAR coleção parametros","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"x":1570.0864639282227,"y":536.476957321167,"wires":[["608d0ef6.c50c3"]]},{"id":"d2ad32e6.b694a","type":"inject","z":"6e1cdd6e.93025c","name":"LIMPAR coleção indice","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"x":1549.8517837524414,"y":630.4168720245361,"wires":[["657b4643.98cd88"]]},{"id":"657b4643.98cd88","type":"mongodb out","z":"6e1cdd6e.93025c","mongodb":"155a161b.16de0a","name":"APAGAR TODA A COLLECTION indice","collection":"indice","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":1935.8517837524414,"y":630.0834980010986,"wires":[]},{"id":"14ec483b.6eda78","type":"inject","z":"6e1cdd6e.93025c","name":"String vazia","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":1518,"y":813,"wires":[["ed7cea7b.4988a8"]]},{"id":"3d797dbe.dc7ba2","type":"mongodb in","z":"6e1cdd6e.93025c","mongodb":"155a161b.16de0a","name":"consulta","collection":"parametros","operation":"find","x":2036.967170715332,"y":813.3554964065552,"wires":[["6ed0643.3b34a9c"]]},{"id":"6ed0643.3b34a9c","type":"debug","z":"6e1cdd6e.93025c","name":"resposta do MongoDB","active":true,"console":"false","complete":"payload","x":2321.078212738037,"y":813.4666519165039,"wires":[]},{"id":"d05e73cc.fbf9a","type":"function","z":"6e1cdd6e.93025c","name":"contador +1","func":"msg.query = { _id: 'AplanadoraN3' }\nmsg.payload = {\n    $inc: {\n       \"os.produzido\": 1\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1839.1892700195312,"y":719.9333190917969,"wires":[["2ddae835.e5ff88"]]},{"id":"2ddae835.e5ff88","type":"mongodb out","z":"6e1cdd6e.93025c","mongodb":"155a161b.16de0a","name":"salvar","collection":"parametros","payonly":true,"upsert":false,"multi":false,"operation":"update","x":2047.1892547607422,"y":720.3333129882812,"wires":[]},{"id":"de197303.b71d1","type":"inject","z":"6e1cdd6e.93025c","name":"$inc: incrementa","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":1526.0228080749512,"y":719.6000156402588,"wires":[["d05e73cc.fbf9a","ae4d87df.532118"]]},{"id":"ed7cea7b.4988a8","type":"function","z":"6e1cdd6e.93025c","name":"Paginação ","func":"msg.limit = 5;\nmsg.skip = 0;\nreturn msg;","outputs":1,"noerr":0,"x":1835.4115238189697,"y":813.4147796630859,"wires":[["3d797dbe.dc7ba2"]]},{"id":"abdef4c5.ec89e8","type":"comment","z":"6e1cdd6e.93025c","name":"Paginação  e consulta MongoDB","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":1554.1893577575684,"y":777.2666192054749,"wires":[]},{"id":"ae4d87df.532118","type":"function","z":"6e1cdd6e.93025c","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nreturn null;","outputs":1,"noerr":0,"x":1838.5226745605469,"y":755.3776063919067,"wires":[["ed7cea7b.4988a8"]]},{"id":"b66dd541.382218","type":"comment","z":"6e1cdd6e.93025c","name":"Contador Produzidos ++ ","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":1531.188850402832,"y":684.2665758132935,"wires":[]},{"id":"22f8853c.a833ca","type":"mqtt-broker","z":"","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"155a161b.16de0a","type":"mongodb","z":"6e1cdd6e.93025c","hostname":"127.0.0.1","port":"27017","db":"db","name":""}]
